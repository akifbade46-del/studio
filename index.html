<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q'go Cargo - Delivery Management</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>

    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4FB8AF"/>

    <!-- Local Stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 loading">

<!-- Login Screen -->
<div id="login-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
<div class="max-w-md w-full space-y-8">
    <div class="text-center">
        <h1 class="qg-logo text-5xl">Q'go<span>Cargo</span></h1>
        <h2 class="mt-4 text-center text-2xl font-bold text-gray-700">Delivery Management Portal</h2>
    </div>
    <div class="mt-8 space-y-6 bg-white p-8 rounded-xl shadow-lg">
        <div class="space-y-4">
            <input id="email-address" name="email" type="email" autocomplete="email" class="input-field" placeholder="Email address">
            <input id="password" name="password" type="password" autocomplete="current-password" class="input-field" placeholder="Password">
        </div>
        <div class="flex items-center justify-between text-sm">
            <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
        </div>
        <div>
            <button id="auth-btn" class="btn btn-primary w-full text-lg">Sign in</button>
        </div>
        <div class="text-center text-sm text-gray-600">
            <p>New Driver? <a href="#" id="driver-signup-link" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up here</a></p>
        </div>
    </div>
</div>
</div>

<!-- Public POD View -->
<div id="public-pod-view" class="hidden"></div>

<!-- Public Feedback View -->
<div id="public-feedback-view" class="hidden min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
<div class="max-w-lg w-full space-y-6 bg-white p-8 rounded-xl shadow-lg text-center">
    <h1 class="qg-logo text-4xl">Q'go<span>Cargo</span></h1>
    <div id="feedback-form-container">
        <h2 class="text-2xl font-bold text-gray-800">Rate Your Delivery</h2>
        <p class="text-gray-500 mt-2">Job File: <span id="feedback-job-no" class="font-medium"></span></p>
        <p class="text-gray-500">Driver: <span id="feedback-driver-name" class="font-medium"></span></p>
        <form id="feedback-form" class="mt-6 space-y-6">
            <input type="hidden" id="feedback-delivery-id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Your Rating</label>
                <div class="rating-stars">
                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">★</label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label>
                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label>
                </div>
            </div>
            <div>
                <label for="feedback-comment" class="block text-sm font-medium text-gray-700">Comments (Optional)</label>
                <textarea id="feedback-comment" rows="4" class="input-field mt-1" placeholder="Tell us about your experience..."></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary w-full">Submit Feedback</button>
            </div>
        </form>
    </div>
    <div id="feedback-thanks-message" class="hidden">
        <h2 class="text-2xl font-bold text-gray-800">Thank You!</h2>
        <p class="text-gray-600 mt-2">Your feedback has been submitted successfully.</p>
    </div>
</div>
</div>


<!-- Main Application Container (Hidden by default) -->
<div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
<!-- Header -->
<header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Delivery System</h1>
        <p id="header-subtitle" class="text-gray-500 mt-1">Assign, track, and manage all job file deliveries.</p>
    </div>
    <div class="text-sm mt-4 sm:mt-0 text-right">
        <p class="font-medium">Welcome, <span id="user-display-name" class="font-bold text-gray-800"></span> (<span id="user-role" class="capitalize text-gray-600"></span>)</p>
        <div class="flex items-center justify-end gap-4 mt-2">
            <button id="driver-dashboard-btn" class="btn btn-secondary text-xs hidden">Driver Dashboard</button>
            <button id="admin-panel-btn" class="btn btn-primary text-xs hidden">Admin Panel</button>
            <button id="logout-btn" class="btn btn-secondary text-xs">Logout</button>
        </div>
    </div>
</header>

<!-- Admin / Staff View -->
<div id="admin-staff-view" class="hidden space-y-12">
    <!-- 1. Dashboard / Overview -->
    <section id="dashboard-section" class="space-y-6">
        <!-- Stat Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-yellow-400 delivery-card">
                <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div><p class="text-base text-gray-500">Pending</p><p id="stat-pending" class="text-3xl font-extrabold text-gray-800">0</p></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-green-400 delivery-card">
                <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div><p class="text-base text-gray-500">Completed</p><p id="stat-completed" class="text-3xl font-extrabold text-gray-800">0</p></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-blue-400 delivery-card">
                <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1z" /></svg></div>
                <div><p class="text-base text-gray-500">Total Deliveries</p><p id="stat-total" class="text-3xl font-extrabold text-gray-800">0</p></div>
            </div>
        </div>
    </section>
    
    <!-- 2. Assign New Delivery -->
    <section class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
            <span>Assign New Delivery</span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
            <div class="space-y-4">
                <div class="relative">
                    <label for="job-file-search" class="block text-sm font-medium text-gray-700 mb-1">Search Job File</label>
                    <input type="text" id="job-file-search" class="input-field" placeholder="Job No, Shipper, or Consignee...">
                    <div id="job-file-suggestions" class="suggestions-container hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Job Details</label>
                    <div class="p-3 bg-gray-50 rounded-md text-sm border">
                        <p><strong>Job No:</strong> <span id="form-job-file-no">Select a job</span></p>
                        <p><strong>Details:</strong> <span id="form-shipper-consignee">N/A</span></p>
                    </div>
                </div>
            </div>
            <form id="delivery-form" class="space-y-4" novalidate>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="delivery-origin" class="block text-sm font-medium text-gray-700 mb-1">Country of Origin</label>
                        <input type="text" id="delivery-origin" class="input-field" placeholder="Auto-filled from Job">
                    </div>
                    <div>
                        <label for="delivery-destination" class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                        <input type="text" id="delivery-destination" class="input-field" placeholder="Auto-filled from Job">
                    </div>
                    <div>
                        <label for="delivery-airlines" class="block text-sm font-medium text-gray-700 mb-1">Airlines</label>
                        <input type="text" id="delivery-airlines" class="input-field" placeholder="Auto-filled from Job">
                    </div>
                    <div>
                        <label for="delivery-mawb" class="block text-sm font-medium text-gray-700 mb-1">AWB / MAWB</label>
                        <input type="text" id="delivery-mawb" class="input-field" placeholder="Auto-filled from Job">
                    </div>
                    <div class="col-span-1 sm:col-span-2">
                        <label for="delivery-inv" class="block text-sm font-medium text-gray-700 mb-1">Invoice No.</label>
                        <input type="text" id="delivery-inv" class="input-field" placeholder="Auto-filled from Job">
                    </div>
                </div>

                <div>
                    <label for="delivery-location" class="block text-sm font-medium text-gray-700 mb-1">Delivery Location</label>
                    <textarea id="delivery-location" rows="2" class="input-field" placeholder="Enter the full delivery address"></textarea>
                </div>
                <div>
                    <label for="additional-notes" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes (Optional)</label>
                    <textarea id="additional-notes" rows="2" class="input-field" placeholder="e.g., Contact person, delivery instructions"></textarea>
                </div>
                <div>
                    <label for="driver-select" class="block text-sm font-medium text-gray-700 mb-1">Assign Driver</label>
                    <select id="driver-select" class="input-field">
                        <option value="">-- Select a Driver --</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="submit" class="btn btn-primary">Assign Delivery</button>
                </div>
            </form>
        </div>
    </section>

    <!-- 3. Delivery Lists -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
               <span>Pending Deliveries</span>
            </h2>
            <input type="text" id="pending-search" class="input-field mb-4" placeholder="Search pending deliveries...">
            <div id="pending-deliveries-list" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Completed Deliveries</span>
            </h2>
            <input type="text" id="completed-search" class="input-field mb-4" placeholder="Search completed deliveries...">
            <div id="completed-deliveries-list" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>
    </section>
</div>

<!-- Driver View -->
<div id="driver-view" class="hidden">
    <section class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b">
            <h2 class="text-2xl font-bold text-gray-800">My Dashboard</h2>
            <button id="my-feedback-btn" class="btn btn-primary text-sm mt-3 sm:mt-0">My Feedback & Ratings</button>
        </div>
        <div id="driver-performance-summary" class="mb-6">
            <!-- Driver performance summary will be loaded here -->
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-4">My Assigned Deliveries</h3>
        <div id="driver-tasks-list" class="space-y-4"></div>
    </section>
</div>
</div>

<!-- Modals -->
<div id="loader-overlay" class="overlay"><div class="loader"></div></div>
<div id="notification"></div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="overlay">
<div class="modal-content max-w-sm">
    <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Action</h3>
    <div id="confirm-message" class="mb-4 text-sm">Are you sure?</div>
    <div class="text-right mt-6 space-x-2">
        <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
        <button id="confirm-ok" class="btn btn-danger">Confirm</button>
    </div>
</div>
</div>

<!-- Admin Panel Modal -->
<div id="admin-panel-modal" class="overlay">
<div class="modal-content max-w-3xl">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold">User Management</h3>
        <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div class="space-y-4">
        <div id="user-list-admin" class="space-y-2 max-h-[60vh] overflow-y-auto">
            <!-- User list will be populated here -->
        </div>
        <div class="text-right">
            <button onclick="saveUserChanges()" class="btn btn-success">Save Changes</button>
        </div>
    </div>
</div>
</div>

<!-- Delivery Completion Modal (for Driver) -->
<div id="delivery-completion-modal" class="overlay">
<div class="modal-content max-w-lg">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold">Complete Delivery</h3>
        <button onclick="closeModal('delivery-completion-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div id="completion-form-wrapper">
        <form id="completion-form" class="space-y-4" novalidate>
            <input type="hidden" id="delivery-id-input">
            <div class="p-4 bg-gray-50 rounded-md">
                <p><strong>Job File:</strong> <span id="modal-job-no"></span></p>
                <p><strong>Location:</strong> <span id="modal-location"></span></p>
            </div>
            <div>
                <label for="receiver-name" class="block text-sm font-medium text-gray-700">Receiver's Name</label>
                <input type="text" id="receiver-name" class="input-field mt-1">
            </div>
            <div>
                <label for="receiver-mobile" class="block text-sm font-medium text-gray-700">Receiver's Mobile Number</label>
                <input type="tel" id="receiver-mobile" class="input-field mt-1">
            </div>
            
             <div>
                <label class="block text-sm font-medium text-gray-700">Photo of Delivery</label>
                <input type="file" id="photo-upload-input" accept="image/*" capture="environment" class="hidden">
                <button type="button" id="take-photo-btn" class="btn btn-secondary text-sm w-full">Take Photo</button>
                <div class="mt-2 text-center">
                    <img id="photo-preview" src="" alt="Photo preview" class="hidden max-w-full h-auto mx-auto rounded-md shadow-md max-h-48"/>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Receiver's Signature</label>
                <div class="relative w-full h-48 mt-1">
                    <canvas id="completion-signature-pad" class="signature-pad-canvas absolute top-0 left-0 w-full h-full"></canvas>
                </div>
                <div class="text-right mt-1">
                    <button type="button" id="clear-completion-signature-btn" class="btn btn-secondary text-xs">Clear</button>
                </div>
            </div>

            <div>
                <button type="button" id="get-location-btn" class="btn btn-secondary text-sm w-full">Get Current Location</button>
                <p id="location-status" class="text-xs text-gray-500 mt-1 text-center"></p>
            </div>
            <div class="flex justify-end items-center gap-4 pt-4">
                <button type="submit" class="btn btn-success">Mark as Delivered</button>
            </div>
        </form>
    </div>
    <!-- This new section will show the QR code after delivery is completed -->
    <div id="post-delivery-qr-wrapper" class="hidden text-center">
        <h3 class="text-xl font-bold text-gray-800">Delivery Complete!</h3>
        <p class="text-gray-600 mt-2 mb-4">Please ask the customer to scan this QR code to rate their delivery experience.</p>
        <div class="flex justify-center my-4">
            <div id="feedback-qrcode-container" class="p-2 bg-white border rounded-lg inline-block"></div>
        </div>
        <p class="text-xs text-gray-500">The customer will use their own device to provide feedback.</p>
        <div class="mt-6 text-center flex justify-center items-center gap-4">
            <button id="skip-feedback-btn" class="btn btn-secondary">Skip Feedback</button>
            <button onclick="closeModal('delivery-completion-modal')" class="btn btn-primary">Finish & Close</button>
        </div>
    </div>
</div>
</div>

<!-- Receipt Modal (For Viewing Receipts) -->
<div id="receipt-modal" class="overlay">
<div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
        <h3 id="receipt-modal-title" class="text-2xl font-bold">View Receipt</h3>
        <button onclick="closeModal('receipt-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    
    <div id="receipt-view">
        <div id="receipt-content" class="p-4 border rounded-md">
            <!-- Receipt content will be generated here -->
        </div>
        <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
             <div class="flex items-center">
                <input type="checkbox" id="generate-as-copy" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="generate-as-copy" class="ml-2 block text-sm text-gray-900">Mark as Copy</label>
            </div>
            <div class="flex flex-wrap justify-end gap-2">
                <button id="copy-link-btn" class="btn btn-secondary">Copy Link</button>
                <button id="share-btn" class="btn btn-primary">Share</button>
                <button id="pdf-receipt-btn" class="btn btn-secondary">PDF</button>
                <button id="print-receipt-btn" class="btn btn-primary">Print</button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Driver Signup Modal -->
<div id="signup-modal" class="overlay">
<div class="modal-content max-w-md">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold">Driver Registration</h3>
        <button onclick="closeModal('signup-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <form id="signup-form" class="space-y-4">
        <div>
            <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
            <input type="text" id="signup-name" class="input-field mt-1" required>
        </div>
        <div>
            <label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label>
            <input type="email" id="signup-email" class="input-field mt-1" required>
        </div>
        <div>
            <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="signup-password" class="input-field mt-1" required>
        </div>
        <div class="text-right pt-4">
            <button type="submit" class="btn btn-primary">Create Account</button>
        </div>
    </form>
</div>
</div>

<!-- Forgot Password Modal -->
<div id="forgot-password-modal" class="overlay">
<div class="modal-content max-w-md">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold">Reset Password</h3>
        <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <form id="forgot-password-form" class="space-y-4">
        <p class="text-sm text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
        <div>
            <label for="forgot-email" class="block text-sm font-medium text-gray-700">Email Address</label>
            <input type="email" id="forgot-email" class="input-field mt-1" required>
        </div>
        <div class="text-right pt-4">
            <button type="submit" class="btn btn-primary">Send Reset Link</button>
        </div>
    </form>
</div>
</div>

<!-- Driver Performance Modal -->
<div id="driver-performance-modal" class="overlay">
<div class="modal-content max-w-4xl">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold">Driver Performance Dashboard</h3>
        <button onclick="closeModal('driver-performance-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div id="driver-performance-body" class="space-y-6">
        <div class="bg-gray-50 p-4 rounded-lg">
            <canvas id="driver-chart"></canvas>
        </div>
        <div id="driver-stats-list" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
    </div>
</div>
</div>

<!-- User-Specific Jobs Modal (For showing driver deliveries) -->
<div id="user-jobs-modal" class="overlay">
<div class="modal-content max-w-5xl">
    <div class="flex justify-between items-center mb-4">
        <h3 id="user-jobs-modal-title" class="text-2xl font-bold">Deliveries</h3>
        <button onclick="closeModal('user-jobs-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div id="user-jobs-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
        <!-- JS will populate this list -->
    </div>
</div>
</div>

<!-- View Feedback Modal -->
<div id="view-feedback-modal" class="overlay">
<div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
        <h3 id="feedback-modal-title" class="text-2xl font-bold">Driver Feedback</h3>
        <button onclick="closeModal('view-feedback-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div id="feedback-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
        <!-- Feedback list will be populated here -->
    </div>
</div>
</div>


<!-- Main Application Logic (Modular) -->
<script type="module" src="script.js"></script>

</body>
</html>
