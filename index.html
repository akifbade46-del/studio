<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q'go Cargo Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css" rel="stylesheet" />
    <style>
        :root {
            --primary: #E30B17;
            --dark: #111827;
            --accent: #0EA5E9;
        }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .bg-dark { background-color: var(--dark); }
        .text-dark { color: var(--dark); }
        .bg-accent { background-color: var(--accent); }
        .text-accent { color: var(--accent); }
        .step { display: none; }
        .step.active { display: block; }
         @media print {
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .no-print { display: none !important; }
          #pdf-output { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="max-w-4xl mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <header id="app-header" class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-50">
             <div class="flex items-center gap-2">
                <img id="header-logo" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNFMzA1MTciIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjEgMTdWNmE0IDQgMCAwIDAtOCAwIi8+PHBhdGggZD0iTTEzIDZWMTRIMyIvPjxwYXRoIGQ9Ik0zIDE0SDEiLz48cGF0aCBkPSJNNyAxNEg2Ii8+PHBhdGggZD0iTTIxIDE3SDMiLz48Y2lyY2xlIGN4PSI4IiBjeT0iMTciIHI9IjIiLz48Y2lyY2xlIGN4PSIxOCIgY3k9IjE3IiByPSIyIi8+PC9zdmc+" alt="Logo" class="h-8 w-8">
                <h1 id="header-title" class="text-xl font-bold text-dark">Q'go Cargo</h1>
            </div>
            <div>
                <button id="editor-mode-btn" class="p-2 rounded hover:bg-gray-200 no-print"><i class="lucide-settings"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 md:p-6">
            <!-- Step 1: Customer Details -->
            <div id="step-1" class="step active">
                <h2 class="text-2xl font-bold mb-4">Customer & Move Details</h2>
                <form id="customer-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Fields will be dynamically inserted here -->
                </form>
            </div>

            <!-- Step 2: Item List -->
            <div id="step-2" class="step">
                <h2 class="text-2xl font-bold mb-4">Items & CBM Calculation</h2>
                <!-- Presets -->
                <div class="mb-4">
                    <h3 class="font-semibold mb-2">Presets</h3>
                    <div id="item-presets" class="flex flex-wrap gap-2"></div>
                </div>
                <!-- Item Form -->
                <div class="border p-4 rounded-lg mb-4">
                    <h3 class="font-semibold mb-2">Add Custom Item</h3>
                    <form id="add-item-form" class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium">Item Name</label>
                            <input type="text" id="item-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Qty</label>
                            <input type="number" id="item-qty" value="1" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium">L×W×H</label>
                                <select id="item-unit" class="text-xs border-gray-300 rounded-md">
                                    <option value="cm">cm</option>
                                    <option value="in">in</option>
                                </select>
                            </div>
                            <div class="flex gap-1 mt-1">
                                <input type="number" step="any" placeholder="L" id="item-l" class="block w-full border-gray-300 rounded-md shadow-sm" required>
                                <input type="number" step="any" placeholder="W" id="item-w" class="block w-full border-gray-300 rounded-md shadow-sm" required>
                                <input type="number" step="any" placeholder="H" id="item-h" class="block w-full border-gray-300 rounded-md shadow-sm" required>
                            </div>
                        </div>
                        <button type="submit" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-90 col-span-2 md:col-span-1"><i class="lucide-plus-circle mr-2"></i>Add</button>
                    </form>
                </div>
                <!-- Items Table -->
                <div class="overflow-x-auto">
                    <table id="items-table" class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 text-left">Item</th>
                                <th class="py-2 px-4 text-left">Qty</th>
                                <th class="py-2 px-4 text-left">CBM/Unit</th>
                                <th class="py-2 px-4 text-left">Total CBM</th>
                                <th class="py-2 px-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: Container Plan -->
            <div id="step-3" class="step">
                <h2 class="text-2xl font-bold mb-4">Container Plan</h2>
                <p class="mb-4">Based on a total of <span id="container-total-cbm" class="font-bold">0.000</span> CBM.</p>
                <div id="container-options" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
            
            <!-- Step 4: Pricing -->
            <div id="step-4" class="step">
                <h2 class="text-2xl font-bold mb-4">Pricing</h2>
                <div id="pricing-breakdown" class="border p-4 rounded-lg space-y-2"></div>
            </div>
            
            <!-- Step 5: Photos & Signature -->
            <div id="step-5" class="step">
                 <h2 class="text-2xl font-bold mb-4">Photos & Signature</h2>
                 <!-- Photos -->
                 <div class="mb-6">
                    <h3 class="font-semibold mb-2">Item Photos</h3>
                    <input type="file" id="photo-upload" accept="image/*" multiple class="hidden">
                    <button onclick="document.getElementById('photo-upload').click()" class="bg-gray-200 p-2 rounded-md"><i class="lucide-upload mr-2"></i>Upload Photos</button>
                    <div id="photos-preview" class="mt-4 grid grid-cols-3 md:grid-cols-5 gap-2"></div>
                 </div>
                 <!-- Signature -->
                 <div>
                    <h3 class="font-semibold mb-2">Customer Signature</h3>
                    <div class="border rounded-md touch-none bg-gray-50">
                       <canvas id="signature-pad" class="w-full h-48"></canvas>
                    </div>
                    <button id="clear-signature" class="mt-2 text-sm text-gray-600">Clear</button>
                 </div>
            </div>
            
            <!-- Step 6: Review & Share -->
            <div id="step-6" class="step">
                <h2 class="text-2xl font-bold mb-4">Review & Share</h2>
                <div id="review-summary" class="space-y-4"></div>
                <div class="mt-6 flex gap-2">
                    <button id="generate-pdf-btn" class="bg-dark text-white p-2 rounded-md"><i class="lucide-file-text mr-2"></i>Generate PDF</button>
                    <button id="share-whatsapp-btn" class="bg-green-500 text-white p-2 rounded-md"><i class="lucide-send mr-2"></i>Share to WhatsApp</button>
                    <button id="save-survey-btn" class="bg-accent text-white p-2 rounded-md"><i class="lucide-save mr-2"></i>Save Survey</button>
                </div>
                 <div id="save-status" class="mt-2 text-sm text-gray-500"></div>
            </div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between no-print">
                <button id="prev-btn" class="bg-gray-300 p-2 rounded-md">Previous</button>
                <div id="step-indicator" class="flex items-center gap-2"></div>
                <button id="next-btn" class="bg-primary text-white p-2 rounded-md">Next</button>
            </div>
        </main>

        <!-- Sticky Footer -->
        <footer id="sticky-footer" class="sticky bottom-0 bg-dark text-white p-2 flex justify-around text-sm md:text-base no-print">
            <div>Total CBM: <span id="footer-total-cbm" class="font-bold">0.000</span></div>
            <div>Grand Total: <span id="footer-grand-total" class="font-bold">0.00 KWD</span></div>
        </footer>
    </div>
    
    <!-- Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Editor Mode</h2>
                <button id="close-editor-btn" class="p-1 rounded-full hover:bg-gray-200"><i class="lucide-x"></i></button>
            </div>
            <div class="flex flex-1 min-h-0">
                <div id="editor-tabs" class="w-1/4 border-r p-2 space-y-1">
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-company">Company Info</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-rates">Rates</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-presets">Item Presets</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-fields">Customer Fields</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-containers">Containers</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-templates">Templates</button>
                     <button class="w-full text-left p-2 rounded editor-tab-btn" data-tab="editor-firebase">Firebase & Data</button>
                </div>
                <div class="w-3/4 p-4 overflow-y-auto">
                    <div id="editor-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Passcode Modal -->
    <div id="passcode-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-lg font-medium mb-4">Enter Passcode</h3>
            <input type="password" id="passcode-input" class="w-full border-gray-300 rounded-md">
            <div class="mt-4 flex justify-end gap-2">
                <button id="passcode-cancel" class="bg-gray-200 p-2 rounded-md">Cancel</button>
                <button id="passcode-submit" class="bg-primary text-white p-2 rounded-md">Unlock</button>
            </div>
        </div>
    </div>

    <!-- PDF Generation Area -->
    <div id="pdf-output-container" class="hidden"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <!-- Main App Logic -->
    <script type="module">
        const D = document;
        const G = (id) => D.getElementById(id);

        const state = {
            currentStep: 1,
            totalSteps: 6,
            survey: {},
            settings: {},
            firebase: { app: null, db: null, storage: null },
        };

        const defaultSettings = {
            company: { name: "Q'go Cargo", address: "123 Cargo Lane, Kuwait City, Kuwait", phone: "+965 1234 5678", email: "contact@qgocargo.com", logo: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNFMzA1MTciIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjEgMTdWNmE0IDQgMCAwIDAtOCAwIi8+PHBhdGggZD0iTTEzIDZWMTRIMyIvPjxwYXRoIGQ9Ik0zIDE0SDEiLz48cGF0aCBkPSJNNyAxNEg2Ii8+PHBhdGggZD0iTTIxIDE3SDMiLz48Y2lyY2xlIGN4PSI4IiBjeT0iMTciIHI9IjIiLz48Y2lyY2xlIGN4PSIxOCIgY3k9IjE3IiByPSIyIi8+PC9zdmc+" },
            branding: { primary: '#E30B17', dark: '#111827', accent: '#0EA5E9' },
            firebaseConfig: null, // To be filled by user
            customerFields: [
                { id: 'name', label: 'Customer Name', type: 'text', required: true, enabled: true },
                { id: 'phone', label: 'Phone', type: 'tel', required: true, enabled: true },
                { id: 'email', label: 'Email', type: 'email', required: false, enabled: true },
                { id: 'pickupAddress', label: 'Pickup Address', type: 'text', required: true, enabled: true },
                { id: 'destinationAddress', label: 'Destination Address', type: 'text', required: true, enabled: true },
                { id: 'surveyDate', label: 'Survey Date', type: 'datetime-local', required: true, enabled: true },
                { id: 'moveType', label: 'Move Type', type: 'select', options: ['Local', 'GCC', 'International'], required: true, enabled: true },
            ],
            itemPresets: [
                { name: 'Carton S', l: 45, w: 45, h: 45 },
                { name: 'Carton M', l: 60, w: 60, h: 60 },
                { name: 'Sofa 3-seater', l: 200, w: 90, h: 80},
            ],
            containers: [
                { type: '20ft', capacity: 33.2, efficiency: 0.85 },
                { type: '40ft', capacity: 67.7, efficiency: 0.85 },
                { type: '40HC', capacity: 76.0, efficiency: 0.85 },
            ],
            rates: {
                currency: 'KWD',
                cbmRates: { Local: 15, GCC: 25, International: 40 },
                minCharge: 100,
                materials: 5,
                labor: 50,
                surcharges: 0,
                insurancePercent: 1.5,
                vatPercent: 5,
                markupPercent: 10,
            },
            templates: {
                pdfTerms: '1. This quote is valid for 30 days.\n2. All goods are handled with care.',
                whatsapp: 'Dear {{customerName}},\n\nPlease find your quote summary. Total is {{grandTotal}} {{currency}}.\n\nThank you,\n{{companyName}}'
            }
        };

        function init() {
            state.settings = JSON.parse(localStorage.getItem('surveyAppSettings')) || defaultSettings;
            state.survey = JSON.parse(localStorage.getItem('currentSurvey')) || createNewSurvey();
            
            initFirebase();
            applyBranding();
            updateUI();
            setupEventListeners();
            renderCustomerForm();
            renderItemPresets();
            renderItemsTable();
            updateFooter();
        }

        function initFirebase() {
            if (state.settings.firebaseConfig && !state.firebase.app) {
                try {
                    state.firebase.app = firebase.initializeApp(state.settings.firebaseConfig);
                    state.firebase.db = firebase.firestore();
                    state.firebase.storage = firebase.storage();
                    console.log("Firebase initialized successfully.");
                } catch (e) {
                    console.error("Could not initialize Firebase. Check your config.", e);
                    alert("Could not initialize Firebase. Please check your configuration in the Editor.");
                }
            }
        }

        function createNewSurvey() {
            return {
                id: `survey-${new Date().toISOString()}-${Math.random().toString(36).substr(2, 9)}`,
                meta: { createdAt: new Date().toISOString() },
                customer: { surveyDate: new Date().toISOString().slice(0, 16) },
                items: [],
                totals: { cbm: 0 },
                media: { photos: [], signature: null }
            };
        }

        function updateUI() {
            D.querySelectorAll('.step').forEach((step, i) => {
                step.classList.toggle('active', i + 1 === state.currentStep);
            });
            G('prev-btn').disabled = state.currentStep === 1;
            G('next-btn').disabled = state.currentStep === state.totalSteps;
            G('next-btn').innerText = state.currentStep === state.totalSteps ? 'Finish' : 'Next';

            const indicatorContainer = G('step-indicator');
            indicatorContainer.innerHTML = '';
            for(let i=1; i <= state.totalSteps; i++) {
                const dot = D.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i === state.currentStep ? 'bg-primary' : 'bg-gray-300'}`;
                indicatorContainer.appendChild(dot);
            }
        }
        
        function applyBranding() {
            const { primary, dark, accent } = state.settings.branding;
            const root = D.documentElement;
            root.style.setProperty('--primary', primary);
            root.style.setProperty('--dark', dark);
            root.style.setProperty('--accent', accent);
            G('header-title').innerText = state.settings.company.name;
            G('header-logo').src = state.settings.company.logo;
        }

        function renderCustomerForm() {
            const form = G('customer-form');
            form.innerHTML = '';
            state.settings.customerFields.forEach(field => {
                if (!field.enabled) return;
                const div = D.createElement('div');
                let inputHtml = '';
                if (field.type === 'select') {
                    inputHtml = `<select id="customer-${field.id}" name="${field.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" ${field.required ? 'required' : ''}>
                        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>`;
                } else {
                    inputHtml = `<input type="${field.type}" id="customer-${field.id}" name="${field.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" ${field.required ? 'required' : ''}>`;
                }
                div.innerHTML = `<label for="customer-${field.id}" class="block text-sm font-medium">${field.label}${field.required ? ' <span class="text-red-500">*</span>' : ''}</label>${inputHtml}`;
                form.appendChild(div);
                const input = G(`customer-${field.id}`);
                if (state.survey.customer[field.id]) {
                    input.value = state.survey.customer[field.id];
                }
                input.addEventListener('input', (e) => {
                    state.survey.customer[e.target.name] = e.target.value;
                    saveDraft();
                });
            });
        }
        
        function renderItemPresets() {
            const container = G('item-presets');
            container.innerHTML = '';
            state.settings.itemPresets.forEach(preset => {
                const btn = D.createElement('button');
                btn.className = 'bg-gray-200 text-sm p-2 rounded-md hover:bg-gray-300';
                btn.innerHTML = `<i class="lucide-box mr-1"></i> ${preset.name}`;
                btn.onclick = () => {
                    addItem({ name: preset.name, qty: 1, l: preset.l, w: preset.w, h: preset.h, unit: 'cm' });
                };
                container.appendChild(btn);
            });
        }

        function calculateCBM(l, w, h, unit) {
            if (unit === 'in') {
                l *= 2.54; w *= 2.54; h *= 2.54;
            }
            return (l * w * h) / 1000000;
        }

        function addItem(itemData) {
            const cbmPerUnit = calculateCBM(itemData.l, itemData.w, itemData.h, itemData.unit);
            state.survey.items.push({
                ...itemData,
                id: `item-${Date.now()}`,
                cbmPerUnit,
                totalCBM: cbmPerUnit * itemData.qty,
            });
            renderItemsTable();
            saveDraft();
        }

        function renderItemsTable() {
            const tbody = G('items-table').querySelector('tbody');
            tbody.innerHTML = '';
            let totalCBM = 0;
            state.survey.items.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="py-2 px-4">${item.name}</td>
                    <td class="py-2 px-4"><input type="number" value="${item.qty}" min="1" class="w-16 border-gray-300 rounded" data-item-id="${item.id}"></td>
                    <td class="py-2 px-4">${item.cbmPerUnit.toFixed(3)}</td>
                    <td class="py-2 px-4">${(item.cbmPerUnit * item.qty).toFixed(3)}</td>
                    <td class="py-2 px-4"><button data-delete-id="${item.id}" class="text-red-500"><i class="lucide-trash-2"></i></button></td>
                `;
                totalCBM += item.cbmPerUnit * item.qty;
            });
            state.survey.totals.cbm = totalCBM;
            updateFooter();
        }
        
        function updateFooter() {
            G('footer-total-cbm').textContent = (state.survey.totals.cbm || 0).toFixed(3);
            G('footer-grand-total').textContent = `${(state.survey.pricing?.grandTotal || 0).toFixed(2)} ${state.settings.rates.currency}`;
        }
        
        function calculateContainerPlan() {
            const containerDiv = G('container-options');
            containerDiv.innerHTML = '';
            const totalCbm = state.survey.totals.cbm;
            G('container-total-cbm').textContent = totalCbm.toFixed(3);
            
            let bestOption = null;

            state.settings.containers.forEach(cont => {
                const effectiveCapacity = cont.capacity * cont.efficiency;
                const utilization = (totalCbm / effectiveCapacity) * 100;
                const containersNeeded = Math.ceil(totalCbm / effectiveCapacity);
                
                if (containersNeeded === 1 && (!bestOption || cont.capacity < bestOption.capacity)) {
                    bestOption = cont.type;
                }

                const card = D.createElement('div');
                card.className = 'border rounded-lg p-4 cursor-pointer';
                card.dataset.containerType = cont.type;
                card.innerHTML = `
                    <h3 class="font-bold flex items-center gap-2"><i class="lucide-truck"></i> ${cont.type}</h3>
                    <p class="text-sm text-gray-600">Capacity: ${cont.capacity.toFixed(2)} CBM</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${Math.min(utilization, 100)}%"></div>
                    </div>
                    <p class="text-sm mt-1">Utilization: ${utilization.toFixed(1)}%</p>
                    ${containersNeeded > 1 ? `<p class="text-sm text-red-500">Requires: ${containersNeeded} containers</p>`: ''}
                `;
                containerDiv.appendChild(card);
            });
            
            if(bestOption) {
                state.survey.containerPlan = { recommended: bestOption };
            }
            if(state.survey.containerPlan.selected) {
                 D.querySelector(`[data-container-type="${state.survey.containerPlan.selected}"]`)?.classList.add('border-primary', 'ring-2', 'ring-primary');
            } else if (bestOption) {
                D.querySelector(`[data-container-type="${bestOption}"]`)?.classList.add('border-accent');
            }
        }

        function calculatePricing() {
            const breakdownDiv = G('pricing-breakdown');
            const { rates } = state.settings;
            const { totals, customer } = state.survey;
            const moveType = customer.moveType || 'Local';
            
            const cbmCost = Math.max(totals.cbm * (rates.cbmRates[moveType] || 0), rates.minCharge);
            const subtotal = cbmCost + rates.materials + rates.labor + rates.surcharges;
            const insurance = subtotal * (rates.insurancePercent / 100);
            const markup = subtotal * (rates.markupPercent / 100);
            const totalBeforeVat = subtotal + insurance + markup;
            const vat = totalBeforeVat * (rates.vatPercent / 100);
            const grandTotal = totalBeforeVat + vat;
            
            state.survey.pricing = { cbmCost, subtotal, insurance, markup, vat, grandTotal, currency: rates.currency };

            breakdownDiv.innerHTML = `
                <div class="flex justify-between"><span>CBM Cost (${moveType}):</span> <span>${cbmCost.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Materials:</span> <span>${rates.materials.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Labor:</span> <span>${rates.labor.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Surcharges:</span> <span>${rates.surcharges.toFixed(2)}</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold"><span>Subtotal:</span> <span>${subtotal.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>Insurance (${rates.insurancePercent}%):</span> <span>${insurance.toFixed(2)}</span></div>
                 <div class="flex justify-between"><span>Markup (${rates.markupPercent}%):</span> <span>${markup.toFixed(2)}</span></div>
                <div class="flex justify-between"><span>VAT (${rates.vatPercent}%):</span> <span>${vat.toFixed(2)}</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold text-xl text-primary"><span>Grand Total:</span> <span>${grandTotal.toFixed(2)} ${rates.currency}</span></div>
            `;
            updateFooter();
        }
        
        function setupReview() {
            const reviewDiv = G('review-summary');
            const { customer, totals, pricing, containerPlan, media } = state.survey;
            
            let photoHtml = '<p>No photos captured.</p>';
            if (media.photos && media.photos.length > 0) {
                photoHtml = media.photos.map(p => `<img src="${p.dataUrl}" class="w-16 h-16 object-cover rounded">`).join('');
            }
            
            let signatureHtml = '<p>No signature captured.</p>';
            if(media.signature) {
                signatureHtml = `<img src="${media.signature}" class="border bg-gray-100 rounded mix-blend-darken">`;
            }

            reviewDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><h4 class="font-bold">Customer</h4><p>${customer.name || ''}</p><p>${customer.phone || ''}</p></div>
                    <div><h4 class="font-bold">Move Details</h4><p>From: ${customer.pickupAddress || ''}</p><p>To: ${customer.destinationAddress || ''}</p><p>Type: ${customer.moveType || ''}</p></div>
                </div>
                <div><h4 class="font-bold">Summary</h4><p>Total CBM: ${totals.cbm.toFixed(3)}</p><p>Container: ${containerPlan.selected || containerPlan.recommended || 'N/A'}</p></div>
                <div><h4 class="font-bold">Pricing</h4><p class="text-primary text-lg">Grand Total: ${pricing?.grandTotal.toFixed(2) || 'N/A'} ${pricing?.currency || ''}</p></div>
                <div><h4 class="font-bold">Photos</h4><div class="flex gap-2 flex-wrap">${photoHtml}</div></div>
                <div><h4 class="font-bold">Signature</h4><div>${signatureHtml}</div></div>
            `;
        }

        function saveDraft() {
            localStorage.setItem('currentSurvey', JSON.stringify(state.survey));
        }

        function setupEventListeners() {
            // Navigation
            G('next-btn').addEventListener('click', () => {
                if (state.currentStep < state.totalSteps) {
                    if(state.currentStep === 2) calculateContainerPlan();
                    if(state.currentStep === 3) calculatePricing();
                    if(state.currentStep === 5) setupReview();
                    state.currentStep++;
                    updateUI();
                }
            });
            G('prev-btn').addEventListener('click', () => {
                if (state.currentStep > 1) {
                    state.currentStep--;
                    updateUI();
                }
            });
            
            // Item Form
            G('add-item-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addItem({
                    name: G('item-name').value,
                    qty: parseInt(G('item-qty').value),
                    l: parseFloat(G('item-l').value),
                    w: parseFloat(G('item-w').value),
                    h: parseFloat(G('item-h').value),
                    unit: G('item-unit').value
                });
                e.target.reset();
            });

            // Items Table Delegation
            G('items-table').addEventListener('change', (e) => {
                if(e.target.matches('input[data-item-id]')) {
                    const itemId = e.target.dataset.itemId;
                    const newQty = parseInt(e.target.value);
                    const item = state.survey.items.find(i => i.id === itemId);
                    if(item) {
                        item.qty = newQty;
                        renderItemsTable();
                        saveDraft();
                    }
                }
            });
             G('items-table').addEventListener('click', (e) => {
                if(e.target.closest('button[data-delete-id]')) {
                    const itemId = e.target.closest('button[data-delete-id]').dataset.deleteId;
                    state.survey.items = state.survey.items.filter(i => i.id !== itemId);
                    renderItemsTable();
                    saveDraft();
                }
            });

            // Container Selection
            G('container-options').addEventListener('click', e => {
                const card = e.target.closest('[data-container-type]');
                if(card) {
                    D.querySelectorAll('[data-container-type]').forEach(c => c.classList.remove('border-primary', 'ring-2', 'ring-primary'));
                    card.classList.add('border-primary', 'ring-2', 'ring-primary');
                    state.survey.containerPlan.selected = card.dataset.containerType;
                    saveDraft();
                }
            });
            
            // Photo upload
            const photoInput = G('photo-upload');
            photoInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files) return;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = D.createElement('canvas');
                            const MAX_DIM = 800;
                            let { width, height } = img;
                            if (width > height) {
                                if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; }
                            } else {
                                if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            state.survey.media.photos.push({id: `photo-${Date.now()}`, dataUrl});
                            renderPhotos();
                            saveDraft();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            });

            function renderPhotos() {
                const preview = G('photos-preview');
                preview.innerHTML = '';
                state.survey.media.photos.forEach(photo => {
                    const div = D.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = `
                        <img src="${photo.dataUrl}" class="w-full h-24 object-cover rounded-md">
                        <button data-photo-id="${photo.id}" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100"><i class="lucide-trash-2 w-4 h-4"></i></button>
                    `;
                    preview.appendChild(div);
                });
            }
             G('photos-preview').addEventListener('click', e => {
                const btn = e.target.closest('[data-photo-id]');
                if(btn) {
                    state.survey.media.photos = state.survey.media.photos.filter(p => p.id !== btn.dataset.photoId);
                    renderPhotos();
                    saveDraft();
                }
            });

            // Signature Pad
            const canvas = G('signature-pad');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            function getMousePos(canvas, evt) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (evt.clientX || evt.touches[0].clientX) - rect.left,
                    y: (evt.clientY || evt.touches[0].clientY) - rect.top
                };
            }
            function startDrawing(e) { drawing = true; draw(e); }
            function stopDrawing() { 
                drawing = false; 
                ctx.beginPath(); 
                state.survey.media.signature = canvas.toDataURL();
                saveDraft();
            }
            function draw(e) {
                e.preventDefault();
                if (!drawing) return;
                const pos = getMousePos(canvas, e);
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#111827';
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', draw);
            G('clear-signature').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                state.survey.media.signature = null;
                saveDraft();
            });

            // Editor Mode
            G('editor-mode-btn').addEventListener('click', () => G('passcode-modal').style.display = 'flex');
            G('passcode-cancel').addEventListener('click', () => G('passcode-modal').style.display = 'none');
            G('passcode-submit').addEventListener('click', () => {
                if (G('passcode-input').value === '1234') {
                    G('passcode-modal').style.display = 'none';
                    G('passcode-input').value = '';
                    G('editor-modal').style.display = 'flex';
                    renderEditor('editor-company');
                } else {
                    alert('Incorrect passcode');
                }
            });
            G('close-editor-btn').addEventListener('click', () => G('editor-modal').style.display = 'none');
            G('editor-tabs').addEventListener('click', e => {
                if(e.target.matches('.editor-tab-btn')) {
                    renderEditor(e.target.dataset.tab);
                }
            });

            G('save-survey-btn').addEventListener('click', saveSurveyToFirestore);
        }
        
        async function saveSurveyToFirestore() {
            const btn = G('save-survey-btn');
            const statusDiv = G('save-status');

            if (!state.firebase.db) {
                alert('Firebase is not configured. Please add your Firebase config in Editor Mode.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="lucide-loader-2 animate-spin mr-2"></i>Saving...`;
            statusDiv.textContent = 'Saving survey to Firebase...';

            try {
                const surveyToSave = JSON.parse(JSON.stringify(state.survey)); // Deep copy
                surveyToSave.meta.savedAt = new Date().toISOString();

                // Handle media separately if needed (e.g., upload to Firebase Storage)
                // For simplicity, we'll store DataURLs in Firestore, but this is not recommended for large images.
                
                await state.firebase.db.collection('surveys').doc(surveyToSave.id).set(surveyToSave);

                statusDiv.textContent = `Survey saved successfully to Firebase with ID: ${surveyToSave.id}`;
                alert(`Survey saved successfully with ID: ${surveyToSave.id}`);

                state.survey = createNewSurvey();
                saveDraft();
                state.currentStep = 1;
                updateUI();
                renderCustomerForm();
                renderItemsTable();

            } catch (error) {
                console.error('Error saving survey to Firebase:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                alert(`Failed to save survey. ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="lucide-save mr-2"></i>Save Survey`;
            }
        }
        
        function renderEditor(tabId) {
            D.querySelectorAll('.editor-tab-btn').forEach(btn => btn.classList.remove('bg-gray-200'));
            D.querySelector(`.editor-tab-btn[data-tab="${tabId}"]`).classList.add('bg-gray-200');

            const content = G('editor-content');
            content.innerHTML = '';
            
            switch (tabId) {
                case 'editor-company':
                    content.innerHTML = `
                        <h3 class="text-xl font-bold mb-4">Company Info</h3>
                        <div class="space-y-4">
                            <div><label class="block">Company Name</label><input type="text" class="w-full border-gray-300 rounded" data-setting="company.name" value="${state.settings.company.name}"></div>
                            <div><label class="block">Address</label><input type="text" class="w-full border-gray-300 rounded" data-setting="company.address" value="${state.settings.company.address}"></div>
                            <div><label class="block">Phone</label><input type="text" class="w-full border-gray-300 rounded" data-setting="company.phone" value="${state.settings.company.phone}"></div>
                            <div><label class="block">Email</label><input type="text" class="w-full border-gray-300 rounded" data-setting="company.email" value="${state.settings.company.email}"></div>
                            <div><label class="block">Logo URL (or Data URL)</label><textarea class="w-full border-gray-300 rounded" data-setting="company.logo">${state.settings.company.logo}</textarea></div>
                        </div>`;
                    break;
                 case 'editor-rates':
                    content.innerHTML = `<h3 class="text-xl font-bold mb-4">Rates & Pricing</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block">Currency</label><input type="text" class="w-full border-gray-300 rounded" data-setting="rates.currency" value="${state.settings.rates.currency}"></div>
                            <div><label class="block">Min Charge</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.minCharge" value="${state.settings.rates.minCharge}"></div>
                            <div><label class="block">CBM Rate (Local)</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.cbmRates.Local" value="${state.settings.rates.cbmRates.Local}"></div>
                            <div><label class="block">CBM Rate (GCC)</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.cbmRates.GCC" value="${state.settings.rates.cbmRates.GCC}"></div>
                            <div><label class="block">CBM Rate (Int'l)</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.cbmRates.International" value="${state.settings.rates.cbmRates.International}"></div>
                            <div><label class="block">Labor Cost</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.labor" value="${state.settings.rates.labor}"></div>
                            <div><label class="block">Insurance %</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.insurancePercent" value="${state.settings.rates.insurancePercent}"></div>
                            <div><label class="block">VAT %</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.vatPercent" value="${state.settings.rates.vatPercent}"></div>
                            <div><label class="block">Markup %</label><input type="number" class="w-full border-gray-300 rounded" data-setting="rates.markupPercent" value="${state.settings.rates.markupPercent}"></div>
                        </div>`;
                    break;
                case 'editor-firebase':
                    content.innerHTML = `<h3 class="text-xl font-bold mb-4">Firebase Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium">Firebase Config (JSON)</label>
                                <textarea id="firebase-config-input" class="w-full border-gray-300 rounded h-48 font-mono text-sm">${JSON.stringify(state.settings.firebaseConfig, null, 2) || ''}</textarea>
                                <p class="text-xs text-gray-500 mt-1">Paste your Firebase project's web configuration object here.</p>
                            </div>
                            <button id="save-firebase-config" class="bg-primary text-white p-2 rounded">Save & Re-initialize Firebase</button>
                             <h4 class="font-bold pt-4">Manage App Settings</h4>
                            <div class="flex gap-2">
                                <button id="export-settings" class="bg-blue-500 text-white p-2 rounded">Export JSON</button>
                                <button onclick="G('import-settings-input').click()" class="bg-gray-200 p-2 rounded">Import JSON</button>
                                <input type="file" id="import-settings-input" class="hidden" accept=".json">
                            </div>
                        </div>`;
                    G('save-firebase-config').addEventListener('click', () => {
                         try {
                            const configStr = G('firebase-config-input').value;
                            if (!configStr) {
                                state.settings.firebaseConfig = null;
                            } else {
                                state.settings.firebaseConfig = JSON.parse(configStr);
                            }
                            saveAndApplySettings();
                            // Force re-initialization
                            state.firebase.app = null; 
                            initFirebase();
                            alert("Firebase configuration saved. The app will now use the new settings.");
                         } catch(e) {
                             alert("Invalid JSON in Firebase config. Please check the format.");
                         }
                    });
                    G('export-settings').addEventListener('click', () => {
                        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.settings, null, 2));
                        const downloadAnchorNode = document.createElement('a');
                        downloadAnchorNode.setAttribute("href", dataStr);
                        downloadAnchorNode.setAttribute("download", "qgo-cargo-settings.json");
                        document.body.appendChild(downloadAnchorNode);
                        downloadAnchorNode.click();
                        downloadAnchorNode.remove();
                    });
                    G('import-settings-input').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                try {
                                    state.settings = JSON.parse(ev.target.result);
                                    saveAndApplySettings();
                                    renderEditor(tabId);
                                    state.firebase.app = null;
                                    initFirebase();
                                } catch (err) {
                                    alert('Invalid JSON file.');
                                }
                            };
                            reader.readAsText(file);
                        }
                    });
                    break;
                 default:
                    content.innerHTML = `<p>This editor section is under construction.</p>`;
            }
            
            content.querySelectorAll('input[data-setting], textarea[data-setting]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const keys = e.target.dataset.setting.split('.');
                    let settingObj = state.settings;
                    keys.slice(0, -1).forEach(key => {
                        settingObj = settingObj[key] = settingObj[key] || {};
                    });
                    const value = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value;
                    settingObj[keys.pop()] = value;
                    saveAndApplySettings();
                });
            });
        }
        
        function saveAndApplySettings() {
            localStorage.setItem('surveyAppSettings', JSON.stringify(state.settings));
            applyBranding();
            renderCustomerForm();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

    