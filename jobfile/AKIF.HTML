
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System - GitHub Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 1rem auto; padding: 1.5rem; background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: var(--theme-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .input-field:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #6b7280; }
        .table-cell { border: 1px solid #e5e7eb; padding: 0.5rem; position: relative; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 1rem; }
        .overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .overlay.visible .modal-content { transform: scale(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translate(-50%, 100px); opacity: 0; transition: transform 0.5s, opacity 0.5s; z-index: 2000; text-align: center; }
        #notification.show { transform: translate(-50%, 0); opacity: 1; }
        @page { size: A4; margin: 0.5cm; }
        @media print { body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } #main-container, .no-print, #app-container, #login-screen { display: none !important; } #print-output { display: block !important; } }
        #print-output .print-table, #preview-modal .print-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td, #preview-modal .print-table th, #preview-modal .print-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        #print-output .print-field, #preview-modal .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        #signup-name-field { display: none; }
        .autocomplete-suggestions { border: 1px solid #d1d5db; border-top: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 150px; overflow-y: auto; position: absolute; background-color: white; z-index: 999; width: 100%; }
        .autocomplete-suggestion { padding: 0.5rem; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <img class="mx-auto h-24 w-auto" src="http://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <div id="main-container" class="container">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">JOB FILE</h1>
                <div class="text-sm">
                    Logged in as: <span id="user-display-name" class="font-bold"></span>
                    <button id="logout-btn" class="ml-4 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Logout</button>
                </div>
            </header>
            
            <div id="main-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-sm text-blue-800">Total Profit</p><p id="stat-total-profit" class="text-2xl font-bold text-blue-900">KD 0.000</p></div>
                <div class="bg-green-100 p-4 rounded-lg text-center"><p class="text-sm text-green-800">Jobs This Month</p><p id="stat-jobs-month" class="text-2xl font-bold text-green-900">0</p></div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-sm text-yellow-800">Average Profit/Job</p><p id="stat-avg-profit" class="text-2xl font-bold text-yellow-900">KD 0.000</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                    <input type="text" id="job-file-no" class="input-field" placeholder="Enter a unique ID...">
                </div>
                <div class="flex items-end space-x-4">
                    <div><span class="font-semibold text-gray-700">Clearance</span><div class="mt-1"><label><input type="checkbox" data-clearance="Export"> Export</label><label class="ml-2"><input type="checkbox" data-clearance="Import"> Import</label></div></div>
                    <div><span class="font-semibold text-gray-700">Product Type</span><div class="mt-1"><label><input type="checkbox" data-product="Air Freight"> Air</label><label class="ml-2"><input type="checkbox" data-product="Sea Freight"> Sea</label><label class="ml-2"><input type="checkbox" data-product="Land Freight"> Land</label></div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div><label for="date" class="block mb-1 font-semibold text-gray-700">Date:</label><input type="date" id="date" class="input-field"></div>
                <div><label for="po-number" class="block mb-1 font-semibold text-gray-700">P.O. #:</label><input type="text" id="po-number" class="input-field"></div>
                <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
                <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
                <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <div class="relative"><label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label><input type="text" id="shipper-name" class="input-field" autocomplete="off"><div id="shipper-suggestions" class="autocomplete-suggestions hidden"></div></div>
                <div class="relative"><label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label><input type="text" id="consignee-name" class="input-field" autocomplete="off"><div id="consignee-suggestions" class="autocomplete-suggestions hidden"></div></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
                <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
                <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
                <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
                <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
                <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
                <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
                <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="sm:col-span-2 lg:col-span-1"><label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label><input type="text" id="description" class="input-field"></div>
                <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line:</label><input type="text" id="carrier" class="input-field"></div>
                <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
            </div>

            <!-- Charges Table -->
            <div class="flex justify-between items-center mb-2"><h2 class="text-xl font-semibold text-gray-800">Charges</h2></div>
            <div class="mb-6 overflow-x-auto border border-gray-200 rounded-lg">
                <table id="charges-table" class="w-full border-collapse"></table>
            </div>
            <div class="text-right mb-6"><button id="add-charge-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Add Charge</button></div>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print flex flex-wrap justify-center gap-2 sm:gap-4">
                 <button id="file-manager-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">File Manager</button>
                 <button id="save-job-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Save to GitHub</button>
                 <button id="new-job-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">New Job</button>
                 <button id="print-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Print</button>
                 <button id="analytics-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Analytics</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden Print Output -->
    <div id="print-output" class="hidden"></div>

    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <div id="file-manager-modal" class="overlay"><div class="modal-content max-w-3xl"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">File Manager</h3><button id="close-fm-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><input type="text" id="fm-search-bar" class="input-field mb-4" placeholder="Search by Job No, Shipper, or Consignee..."><div id="job-files-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div></div></div>
    <div id="confirm-modal" class="overlay"><div class="modal-content max-w-sm"><h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm</h3><div id="confirm-message" class="mb-4 text-sm">Are you sure?</div><div class="text-right mt-6 space-x-2"><button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button><button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm</button></div></div></div>
    <div id="preview-modal" class="overlay"><div class="modal-content max-w-4xl"><div class="flex justify-between items-center mb-4 no-print"><h3 class="text-2xl font-bold">Job File Preview</h3><div><button id="print-preview-btn" title="Print Preview" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">🖨️ Print</button><button id="close-preview-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div></div><div id="preview-body"></div></div></div>
    <div id="analytics-modal" class="overlay"><div class="modal-content max-w-6xl"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">Analytics Dashboard</h3><button id="close-analytics-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="analytics-body" class="space-y-6"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";
        
        // --- CONFIGURATION ---
        const GITHUB_CONFIG = {
            TOKEN: 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN', // ⚠️ PASTE YOUR TOKEN HERE
            USER: 'YOUR_GITHUB_USERNAME',               // Replace with your GitHub username
            REPO: 'YOUR_GITHUB_REPOSITORY_NAME',        // Replace with your repository name
            BRANCH: 'main',                             // Or 'master'
            DATA_PATH: 'data/'                          // Folder in your repo for job files
        };

        // --- Globals ---
        let auth;
        let currentUser = null;
        let jobFilesCache = [];

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system"
        };
        
        // --- GitHub API Functions ---
        async function githubApiRequest(url, method = 'GET', body = null) {
            const headers = {
                'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };
            const options = { method, headers };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`GitHub API Error (${response.status}): ${errorData.message}`);
            }
            // For DELETE requests, response might be empty
            return response.status === 204 ? null : response.json();
        }

        async function saveJobFileToGitHub(fileId, content, isUpdating) {
            const filePath = `${GITHUB_CONFIG.DATA_PATH}${fileId}.json`;
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${filePath}`;

            content.updatedAt = new Date().toISOString();
            if(!isUpdating) {
                content.createdAt = new Date().toISOString();
            }

            const payload = {
                message: `${isUpdating ? 'Update' : 'Create'} job file: ${fileId}`,
                content: btoa(JSON.stringify(content, null, 2)), // btoa encodes to base64
                branch: GITHUB_CONFIG.BRANCH
            };

            if (isUpdating) {
                try {
                    const existingFile = await githubApiRequest(apiUrl);
                    payload.sha = existingFile.sha;
                } catch (error) {
                     if (error.message.includes('404')) {
                        // File doesn't exist, so it's a create operation, not an update.
                        // No SHA needed.
                    } else {
                        throw error; // Re-throw other errors
                    }
                }
            }
            
            return githubApiRequest(apiUrl, 'PUT', payload);
        }

        async function loadJobFilesFromGitHub() {
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${GITHUB_CONFIG.DATA_PATH}`;
            const files = await githubApiRequest(apiUrl);
            
            const summaries = await Promise.all(files
                .filter(file => file.name.endsWith('.json'))
                .map(async file => {
                    const content = await loadSingleJobFileFromGitHub(file.name.replace('.json', ''));
                    return {
                        id: file.name.replace('.json', ''),
                        jfn: content.jfn || '',
                        sh: content.sh || '',
                        co: content.co || '',
                        totalProfit: content.totalProfit || 0,
                        bd: content.bd || '',
                        updatedAt: content.updatedAt || new Date(0).toISOString()
                    };
                })
            );
            return summaries;
        }

        async function loadSingleJobFileFromGitHub(fileId) {
            const filePath = `${GITHUB_CONFIG.DATA_PATH}${fileId}.json`;
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${filePath}`;
            const fileData = await githubApiRequest(apiUrl);
            const content = atob(fileData.content); // atob decodes from base64
            return JSON.parse(content);
        }

        async function deleteJobFileFromGitHub(fileId) {
            const filePath = `${GITHUB_CONFIG.DATA_PATH}${fileId}.json`;
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${filePath}`;
            
            // Get SHA first
            const fileData = await githubApiRequest(apiUrl);

            const payload = {
                message: `Delete job file: ${fileId}`,
                sha: fileData.sha,
                branch: GITHUB_CONFIG.BRANCH
            };
            return githubApiRequest(apiUrl, 'DELETE', payload);
        }
        
        // --- Core App Logic ---
        function initializeAppLogic() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = { uid: user.uid, email: user.email, displayName: user.displayName || user.email.split('@')[0] };
                        console.log("User logged in:", currentUser);
                        await showApp();
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLogin();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to authentication service.", true);
            }
        }

        async function loadAllJobFilesForCache() {
            showLoader();
            try {
                const summaries = await loadJobFilesFromGitHub();
                jobFilesCache = summaries.sort((a,b) => b.updatedAt.localeCompare(a.updatedAt));
                updateMainPageStats();
            } catch (error) {
                jobFilesCache = [];
                console.error("Failed to load job files from GitHub:", error);
                showNotification("Failed to load job files. Check console & GitHub config.", true);
            } finally {
                hideLoader();
            }
        }
        
        // --- UI Control ---
        async function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            await loadAllJobFilesForCache();
            clearForm();
        }
        
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function clearForm() {
            const mainContainer = document.getElementById('main-container');
            if (mainContainer) {
                const form = mainContainer.querySelector('form') || mainContainer;
                // Safely reset if it's a form element
                if(typeof form.reset === 'function') {
                    form.reset();
                } else { // Fallback for div
                    mainContainer.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(input => input.value = '');
                    mainContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                }
            }
            if (document.getElementById('job-file-no')) document.getElementById('job-file-no').disabled = false;
            if (document.getElementById('date')) document.getElementById('date').valueAsDate = new Date();
            populateTable();
            calculate();
        }

        // --- Event Handlers & Button Actions ---
        async function saveJobFile() {
            const jobFileNo = document.getElementById('job-file-no').value.trim();
            if (!jobFileNo) {
                showNotification("Job File No. is required.", true);
                return;
            }
            
            const isUpdating = document.getElementById('job-file-no').disabled;
            const data = getFormData();
            
            showLoader();
            try {
                await saveJobFileToGitHub(jobFileNo, data, isUpdating);
                showNotification(`Job file "${jobFileNo}" saved successfully!`);
                await loadAllJobFilesForCache();
                document.getElementById('job-file-no').disabled = true;
            } catch(error) {
                console.error("Save error:", error);
                showNotification(`Failed to save file: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }
        
        async function openFileManager() {
            showLoader();
            try {
                // Use cache if available, otherwise fetch
                if (jobFilesCache.length === 0) {
                     const summaries = await loadJobFilesFromGitHub();
                     jobFilesCache = summaries.sort((a,b) => b.updatedAt.localeCompare(a.updatedAt));
                }
                displayJobFiles(jobFilesCache);
                openModal('file-manager-modal');
            } catch (error) {
                 showNotification(`Could not open File Manager: ${error.message}`, true);
            } finally {
                 hideLoader();
            }
        }
        
        function displayJobFiles(files) {
            const list = document.getElementById('job-files-list');
            if (!files || files.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center p-4">No job files found.</p>`;
                return;
            }
            list.innerHTML = files.map(file => `
                <div class="border p-3 rounded-lg flex justify-between items-center bg-gray-50 hover:bg-gray-100">
                    <div>
                        <p class="font-bold text-indigo-700">${file.jfn || 'No ID'}</p>
                        <p class="text-sm text-gray-600">Shipper: ${file.sh || 'N/A'}</p>
                        <p class="text-xs text-gray-400">Last Updated: ${new Date(file.updatedAt).toLocaleString()}</p>
                    </div>
                    <div class="space-x-2">
                        <button class="bg-blue-500 text-white font-bold py-1 px-3 rounded text-sm" onclick="window.previewJobFile('${file.id}')">Preview</button>
                        <button class="bg-green-500 text-white font-bold py-1 px-3 rounded text-sm" onclick="window.loadJobFile('${file.id}')">Load</button>
                        <button class="bg-red-500 text-white font-bold py-1 px-3 rounded text-sm" onclick="window.confirmDelete('${file.id}')">Delete</button>
                    </div>
                </div>`).join('');
        }

        async function loadJobFile(fileId) {
            showLoader();
            try {
                const data = await loadSingleJobFileFromGitHub(fileId);
                populateFormFromData(data);
                document.getElementById('job-file-no').disabled = true;
                closeModal('file-manager-modal');
                showNotification(`Loaded job file "${data.jfn}".`);
            } catch (error) {
                console.error("Load error:", error);
                showNotification(`Failed to load file: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        async function deleteJobFile(fileId) {
            showLoader();
            try {
                await deleteJobFileFromGitHub(fileId);
                showNotification(`Job file "${fileId.replace(/_/g, '/')}" deleted.`);
                await openFileManager(); // Refresh file list
            } catch(error) {
                 console.error("Delete error:", error);
                showNotification(`Failed to delete file: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }
        
        function confirmDelete(fileId) {
             const modal = document.getElementById('confirm-modal');
             modal.querySelector('#confirm-message').textContent = `Are you sure you want to delete job file "${fileId.replace(/_/g, '/')}"? This action cannot be undone.`;
             openModal('confirm-modal');
             const okButton = modal.querySelector('#confirm-ok');
             
             const handler = () => {
                 deleteJobFile(fileId);
                 closeModal('confirm-modal');
             };
             
             // Remove old listener before adding new one
             okButton.replaceWith(okButton.cloneNode(true));
             document.getElementById('confirm-ok').addEventListener('click', handler);
        }

        // --- Analytics ---
        function openAnalyticsDashboard() {
            const body = document.getElementById('analytics-body');
            body.innerHTML = '';
            
            let totalProfit = 0;
            const profitByMonth = {};

            jobFilesCache.forEach(job => {
                const profit = parseFloat(job.totalProfit) || 0;
                totalProfit += profit;
                const month = job.bd ? job.bd.substring(0, 7) : 'Unknown';
                if(month !== 'Unknown') {
                    profitByMonth[month] = (profitByMonth[month] || 0) + profit;
                }
            });

            const sortedMonths = Object.keys(profitByMonth).sort();

            body.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm text-gray-600">Total Jobs</p><p class="text-2xl font-bold">${jobFilesCache.length}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800">Total Profit</p><p class="text-2xl font-bold text-green-900">KD ${totalProfit.toFixed(3)}</p></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mt-4">
                    <canvas id="profit-chart"></canvas>
                </div>
            `;
            
            const ctx = document.getElementById('profit-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Monthly Profit',
                        data: sortedMonths.map(month => profitByMonth[month]),
                        borderColor: 'rgba(79, 70, 229, 1)',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        fill: true,
                    }]
                }
            });

            openModal('analytics-modal');
        }

        // --- Other Functions ---
        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);
            const charges = [];
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                const description = row.querySelector('.description-input').value;
                if(description) charges.push({ l: description, c: row.querySelector('.cost-input').value || '0', s: row.querySelector('.selling-input').value || '0', n: '' });
            });
            const totalCost = parseFloat(document.getElementById('total-cost').textContent) || 0;
            const totalSelling = parseFloat(document.getElementById('total-selling').textContent) || 0;
            const totalProfit = parseFloat(document.getElementById('total-profit').textContent) || 0;
            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'), cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'), in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'), sh: getVal('shipper-name'), co: getVal('consignee-name'), mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'), pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'), dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'), ch: charges, totalCost: totalCost, totalSelling: totalSelling, totalProfit: totalProfit, createdBy: currentUser.displayName
            };
        }
        
        function populateFormFromData(data) {
            clearForm();
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => { document.querySelectorAll(`[data-${type}]`).forEach(el => el.checked = (values || []).includes(el.dataset[type])); };
            
            const fieldMap = { d: 'date', po: 'po-number', jfn: 'job-file-no', in: 'invoice-no', bd: 'billing-date', sm: 'salesman', sh: 'shipper-name', co: 'consignee-name', mawb: 'mawb', hawb: 'hawb', ts: 'teams-of-shipping', or: 'origin', pc: 'no-of-pieces', gw: 'gross-weight', de: 'destination', vw: 'volume-weight', dsc: 'description', ca: 'carrier', tn: 'truck-no' };
            Object.keys(fieldMap).forEach(key => setVal(fieldMap[key], data[key]));

            setChecked('clearance', data.cl); setChecked('product', data.pt);
            
            // Clear table before populating
            const tableBody = document.getElementById('charges-table-body');
            tableBody.innerHTML = '';
            if (data.ch && data.ch.length > 0) {
                 data.ch.forEach(charge => addChargeRow(charge)); 
            } else {
                 for(let i=0; i<10; i++) addChargeRow(); // Add empty rows if none exist
            }
            calculate();
        }

        // --- DOMContentLoaded Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();

            let isLoginView = true;
            document.getElementById('auth-link').addEventListener('click', (e) => { e.preventDefault(); isLoginView = !isLoginView; toggleAuthView(isLoginView); });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('auth-btn').addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                showLoader();
                if (isLoginView) { 
                    signInWithEmailAndPassword(auth, email, password)
                        .catch(err => { showNotification(err.message, true); hideLoader(); });
                } 
                else { 
                    const displayName = document.getElementById('full-name').value;
                    createUserWithEmailAndPassword(auth, email, password)
                        .then(() => { showNotification("Account created! You can now log in."); toggleAuthView(true); })
                        .catch(err => showNotification(err.message, true))
                        .finally(() => hideLoader()); 
                }
            });
            
            document.getElementById('new-job-btn').addEventListener('click', clearForm);
            document.getElementById('save-job-btn').addEventListener('click', saveJobFile);
            document.getElementById('file-manager-btn').addEventListener('click', openFileManager);
            document.getElementById('analytics-btn').addEventListener('click', openAnalyticsDashboard);
            document.getElementById('add-charge-btn').addEventListener('click', () => addChargeRow());
            document.getElementById('print-btn').addEventListener('click', () => {
                 const data = getFormData();
                 if(!data.jfn) { showNotification("Please save the file first to generate a printable version.", true); return; }
                 const printHTML = getPrintViewHtml(data);
                 document.getElementById('print-output').innerHTML = printHTML;
                 window.print();
            });
            
            document.getElementById('close-fm-btn').addEventListener('click', () => closeModal('file-manager-modal'));
            document.getElementById('close-preview-btn').addEventListener('click', () => closeModal('preview-modal'));
            document.getElementById('close-analytics-btn').addEventListener('click', () => closeModal('analytics-modal'));
            document.getElementById('confirm-cancel').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('print-preview-btn').addEventListener('click', () => { 
                const content = document.getElementById('preview-body').innerHTML; 
                const printWindow = window.open('', '', 'height=800,width=1200'); 
                printWindow.document.write('<html><head><title>Print</title><script src="https://cdn.tailwindcss.com"><\/script><style>body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }</style></head><body>' + content + '</body></html>'); 
                printWindow.document.close(); printWindow.print(); 
            });

            document.getElementById('fm-search-bar').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = jobFilesCache.filter(file => (file.jfn || '').toLowerCase().includes(term) || (file.sh || '').toLowerCase().includes(term) || (file.co || '').toLowerCase().includes(term));
                displayJobFiles(filtered);
            });
            
            // Make functions globally accessible for inline onclick handlers
            window.loadJobFile = loadJobFile;
            window.previewJobFile = async (fileId) => {
                showLoader();
                try {
                    const data = await loadSingleJobFileFromGitHub(fileId);
                    document.getElementById('preview-body').innerHTML = getPrintViewHtml(data);
                    openModal('preview-modal');
                } catch(error) {
                    showNotification(`Could not preview file: ${error.message}`, true);
                }
                finally {
                    hideLoader();
                }
            };
            window.confirmDelete = confirmDelete;

            populateTable();
            if(document.getElementById('date')) document.getElementById('date').valueAsDate = new Date();
        });
        
        function showNotification(message, isError = false) { const el = document.getElementById('notification'); el.textContent = message; el.style.backgroundColor = isError ? '#c53030' : '#2d3748'; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000); }
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }
        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        function toggleAuthView(showLogin) { document.getElementById('signup-name-field').style.display = showLogin ? 'none' : 'block'; document.getElementById('auth-title').textContent = showLogin ? 'Sign in' : 'Create an account'; document.getElementById('auth-btn').textContent = showLogin ? 'Sign in' : 'Sign up'; document.getElementById('auth-link').textContent = showLogin ? 'Create an account' : 'Sign in';}
        function calculate() { let totalCost = 0, totalSelling = 0; document.querySelectorAll('#charges-table-body tr').forEach(row => { const cost = parseFloat(row.querySelector('.cost-input').value) || 0; const selling = parseFloat(row.querySelector('.selling-input').value) || 0; row.cells[3].textContent = (selling - cost).toFixed(3); totalCost += cost; totalSelling += selling; }); document.getElementById('total-cost').textContent = totalCost.toFixed(3); document.getElementById('total-selling').textContent = totalSelling.toFixed(3); document.getElementById('total-profit').textContent = (totalSelling - totalCost).toFixed(3); }
        function populateTable() { const table = document.getElementById('charges-table'); table.innerHTML = `<thead><tr class="bg-gray-100 text-left"><th class="table-cell font-semibold w-2/5">Description</th><th class="table-cell font-semibold">Cost</th><th class="table-cell font-semibold">Selling</th><th class="table-cell font-semibold">Profit</th><th class="table-cell font-semibold"></th></tr></thead><tbody id="charges-table-body"></tbody><tfoot><tr class="bg-gray-100 font-bold"><td class="table-cell text-right">TOTAL:</td><td id="total-cost" class="table-cell text-right">0.000</td><td id="total-selling" class="table-cell text-right">0.000</td><td id="total-profit" class="table-cell text-right">0.000</td><td class="table-cell"></td></tr></tfoot>`; const tableBody = document.getElementById('charges-table-body'); tableBody.addEventListener('input', calculate); for(let i=0; i<10; i++) addChargeRow(); }
        function addChargeRow(data = {}) { const newRow = document.getElementById('charges-table-body').insertRow(); newRow.innerHTML = `<td class="table-cell"><input type="text" class="description-input input-field" value="${data.l || ''}"></td><td class="table-cell"><input type="number" step="0.001" class="cost-input input-field" value="${data.c || ''}"></td><td class="table-cell"><input type="number" step="0.001" class="selling-input input-field" value="${data.s || ''}"></td><td class="profit-output text-right p-2 bg-gray-50">${((data.s || 0) - (data.c || 0)).toFixed(3)}</td><td class="table-cell text-center"><button class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></td>`; newRow.querySelector('button').addEventListener('click', () => { newRow.remove(); calculate(); }); newRow.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate)); }
        function getPrintViewHtml(data) { const totalCost = (data.ch || []).reduce((sum, item) => sum + (parseFloat(item.c) || 0), 0); const totalSelling = (data.ch || []).reduce((sum, item) => sum + (parseFloat(item.s) || 0), 0); const totalProfit = totalSelling - totalCost; return `<div class="border p-4 bg-white"><div class="text-center mb-4"><h1 class="text-2xl font-bold">Q'GO CARGO</h1><h2 class="text-xl">JOB FILE</h2></div><div class="grid grid-cols-2 gap-4 text-sm"><div><strong>Job No:</strong> ${data.jfn}</div><div class="text-right"><strong>Date:</strong> ${data.d}</div><div><strong>Shipper:</strong> ${data.sh}</div><div><strong>Consignee:</strong> ${data.co}</div></div><hr class="my-4"><table class="print-table w-full text-sm"><thead><tr><th>Description</th><th>Cost</th><th>Selling</th><th>Profit</th></tr></thead><tbody>${(data.ch || []).map(c => `<tr><td>${c.l}</td><td>${c.c}</td><td>${c.s}</td><td>${(parseFloat(c.s || 0) - parseFloat(c.c || 0)).toFixed(3)}</td></tr>`).join('')}</tbody><tfoot><tr class="font-bold bg-gray-100"><td>TOTAL</td><td>${totalCost.toFixed(3)}</td><td>${totalSelling.toFixed(3)}</td><td>${totalProfit.toFixed(3)}</td></tr></tfoot></table></div>`; }
        function updateMainPageStats() { const totalProfit = jobFilesCache.reduce((sum, job) => sum + (parseFloat(job.totalProfit) || 0), 0); const jobsThisMonth = jobFilesCache.filter(job => job.bd && job.bd.startsWith(new Date().toISOString().substring(0, 7))).length; const avgProfit = jobFilesCache.length > 0 ? totalProfit / jobFilesCache.length : 0; document.getElementById('stat-total-profit').textContent = `KD ${totalProfit.toFixed(3)}`; document.getElementById('stat-jobs-month').textContent = jobsThisMonth; document.getElementById('stat-avg-profit').textContent = `KD ${avgProfit.toFixed(3)}`; }
    </script>
</body>
</html>
