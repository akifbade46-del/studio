
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q'go Cargo - Job File System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #0E639C; --accent-color: #4FB8AF; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 1rem auto; padding: 1.5rem; }
        @media (min-width: 640px) { .container { margin: 2rem auto; padding: 2.5rem; } }
        .input-field, select {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: white;
        }
        .input-field:focus, select:focus { outline: none; border-color: var(--theme-color); box-shadow: 0 0 0 2px rgba(14, 99, 156, 0.2); }
        .input-field:disabled, .input-field[readonly] { background-color: #f3f4f6; cursor: not-allowed; color: #6b7280; }
        .table-cell { border: 1px solid #e5e7eb; padding: 0.5rem; position: relative; }
        @media (min-width: 640px) { .table-cell { padding: 0.75rem; } }
        .table-cell input { width: 100%; border: none; padding: 0; background-color: transparent; }
        .table-cell input:focus { outline: none; }
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 1rem;
        }
        .overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem; width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content { transform: scale(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%; background-color: #2d3748; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translate(-50%, 100px); opacity: 0; transition: transform 0.5s, opacity 0.5s; z-index: 2000; text-align: center;
        }
        #notification.show { transform: translate(-50%, 0); opacity: 1; }
        .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only { display: none; }
        .stamp { position: absolute; top: -10px; right: -10px; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; text-transform: uppercase; transform: rotate(15deg); opacity: 0.8; display: none; }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }
        .autocomplete-suggestions {
            border: 1px solid #d1d5db; border-top: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 150px; overflow-y: auto;
            position: absolute; background-color: white; z-index: 999; width: 100%;
        }
        .autocomplete-suggestion { padding: 0.5rem; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f3f4f6; }
        .file-action-btn { padding: 0.25rem 0.75rem; color: white; border-radius: 0.25rem; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <!-- Content will be injected by JS -->
    </div>

    <!-- Main App -->
    <div id="app-container" class="container hidden">
        <!-- Content will be injected by JS -->
    </div>
    
    <!-- Modals, loader, etc. -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    <div id="file-manager-modal" class="overlay"></div>
    <div id="print-preview-modal" class="overlay"></div>
    <div id="analytics-modal" class="overlay"></div>
    <div id="client-manager-modal" class="overlay"></div>
    <div id="admin-panel-modal" class="overlay"></div>
    <div id="recycle-bin-modal" class="overlay"></div>
    <div id="charge-manager-modal" class="overlay"></div>
    <div id="activity-log-modal" class="overlay"></div>
    <div id="confirm-reject-modal" class="overlay"></div>
    <div id="confirm-delete-modal" class="overlay"></div>
    <div id="confirm-restore-modal" class="overlay"></div>
    <div id="forgot-password-modal" class="overlay"></div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- Main Application Logic -->
    <script>
    // Self-executing function to encapsulate all the code
    (function() {
        document.addEventListener('DOMContentLoaded', () => {

            // --- GLOBAL STATE ---
            let db, auth;
            let currentUser = null;
            let jobFilesCache = [];
            let clientsCache = [];
            let allUsersCache = [];
            let chargeDescriptions = [];
            let currentJobFile = null;
            let profitChartInstance, salesmanChartInstance;
            let fileIdToReject = null;
            let isLoginView = true;
            let activityLog = [];

            // --- DOM TEMPLATES ---
            const loginTemplate = `
                <div class="max-w-md w-full space-y-8">
                    <div><img class="mx-auto h-20 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo"></div>
                    <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
                    <div id="approval-message" class="hidden text-center p-4 bg-yellow-100 text-yellow-800 rounded-md">Thank you for signing up. Your account is awaiting admin approval.</div>
                    <div id="blocked-message" class="hidden text-center p-4 bg-red-100 text-red-800 rounded-md">Your account has been blocked. Please contact an administrator.</div>
                    <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                        <div class="rounded-md shadow-sm -space-y-px">
                            <div id="signup-name-field" style="display: none;"><input id="full-name" name="name" type="text" class="input-field rounded-t-md" placeholder="Full Name"></div>
                            <div><input id="email-address" name="email" type="email" required class="input-field rounded-b-md" placeholder="Email address"></div>
                            <div><input id="password" name="password" type="password" required class="input-field rounded-t-md mt-2" placeholder="Password"></div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
                            <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">Create a new account</a>
                        </div>
                        <div><button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Sign in</button></div>
                    </div>
                </div>`;
            
            const appTemplate = `
                <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b-2 border-gray-200">
                    <div><img class="h-16 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo"></div>
                    <div class="text-right mt-4 sm:mt-0">
                        <p>Welcome, <strong id="user-display-name"></strong> (<span id="user-role" class="capitalize"></span>)</p>
                        <button id="logout-btn" class="text-sm text-indigo-600 hover:text-indigo-800">Logout</button>
                    </div>
                </header>

                <div id="main-page-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <form id="job-file-form"></form>
                </div>
            `;

            // Injecting templates
            document.getElementById('login-screen').innerHTML = loginTemplate;
            document.getElementById('app-container').innerHTML = appTemplate;

            // --- CORE UTILITY FUNCTIONS ---
            const getEl = (id) => document.getElementById(id);
            const querySel = (selector) => document.querySelector(selector);
            const querySelAll = (selector) => document.querySelectorAll(selector);
            const showLoader = () => getEl('loader-overlay').classList.add('visible');
            const hideLoader = () => getEl('loader-overlay').classList.remove('visible');
            
            const showNotification = (message, isError = false) => {
                const notification = getEl('notification');
                if (!notification) return;
                notification.textContent = message;
                notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            };

            const openModal = (id) => { getEl(id).classList.add('visible'); };
            const closeModal = (id) => { getEl(id).classList.remove('visible'); };
            const closeAllModals = () => querySelAll('.overlay').forEach(modal => modal.classList.remove('visible'));

            const logActivity = (action) => {
                activityLog.unshift({ action: action, user: currentUser.displayName, time: new Date().toLocaleString() });
                if (activityLog.length > 100) activityLog.pop(); // Keep log size manageable
            };
            
            // --- Authentication ---
            const handleSignUp = async (email, password, displayName) => {
                showLoader();
                try {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                    showNotification("Account created! Please wait for admin approval.", false);
                    await firebase.auth().signOut();
                    toggleAuthView(true);
                } catch (error) { showNotification(error.message, true); }
                hideLoader();
            };

            const handleLogin = async (email, password) => {
                showLoader();
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) { showNotification("Incorrect email or password.", true); }
                hideLoader();
            };
            
            const handleForgotPassword = async () => {
                const email = getEl('reset-email').value.trim();
                if (!email) { showNotification("Please enter your email address.", true); return; }
                showLoader();
                try {
                    await firebase.auth().sendPasswordResetEmail(email);
                    hideLoader();
                    closeModal('forgot-password-modal');
                    showNotification("Password reset link sent!", false);
                } catch (error) { hideLoader(); showNotification("Could not send reset link.", true); }
            };
            
            const handleLogout = () => firebase.auth().signOut();

            const toggleAuthView = (isLogin) => {
                isLoginView = isLogin;
                getEl('auth-title').textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
                getEl('auth-btn').textContent = isLogin ? 'Sign in' : 'Sign up';
                getEl('auth-link').textContent = isLogin ? 'Create a new account' : 'Already have an account? Sign in';
                getEl('signup-name-field').style.display = isLogin ? 'none' : 'block';
                const emailField = getEl('email-address');
                emailField.classList.toggle('rounded-t-md', !isLogin);
                emailField.classList.toggle('rounded-md', isLogin);
            };
            
            const showLoginScreen = () => {
                getEl('login-screen').style.display = 'flex';
                getEl('app-container').style.display = 'none';
            };

            const showApp = async () => {
                getEl('login-screen').style.display = 'none';
                getEl('app-container').style.display = 'block';

                if (currentUser) {
                    getEl('user-display-name').textContent = currentUser.displayName;
                    getEl('user-role').textContent = currentUser.role;
                }
                
                await loadAllJobFilesForCache();
                clearForm();
            };

            // --- API Request Wrapper ---
            const handleApiRequest = async (script, options, successMessage, errorMessage) => {
                showLoader();
                try {
                    const response = await fetch(script, options);
                    const textResponse = await response.text();
                    
                    if (!response.ok) {
                       throw new Error(`Server responded with ${response.status}: ${textResponse || 'Server Error'}`);
                    }
                    
                    try {
                        const result = JSON.parse(textResponse);
                         if (result.status !== 'success') throw new Error(result.message || 'An unknown error occurred.');
                         if (successMessage) showNotification(successMessage);
                         return result;
                    } catch (e) {
                         throw new Error(`Invalid JSON response: ${textResponse}`);
                    }

                } catch (error) {
                    console.error(`Error in ${script}:`, error);
                    showNotification(`${errorMessage} (${error.message})`, true);
                    return null;
                } finally {
                    hideLoader();
                }
            };
            
            // --- MAIN INITIALIZER ---
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
                    authDomain: "my-job-file-system.firebaseapp.com",
                    projectId: "my-job-file-system",
                };
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const userDocRef = db.collection('users').doc(user.uid);
                            let userDoc = await userDocRef.get();
                            
                            if (!userDoc.exists) { // Corrected: compat mode uses .exists property, not .exists() method
                                const usersCollectionRef = db.collection('users');
                                const userQuerySnapshot = await usersCollectionRef.get();
                                const isFirstUser = userQuerySnapshot.size === 0;
                                const newUser = {
                                    email: user.email,
                                    displayName: user.displayName || user.email.split('@')[0],
                                    role: isFirstUser ? 'admin' : 'user',
                                    status: isFirstUser ? 'active' : 'inactive',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                await userDocRef.set(newUser);
                                userDoc = await userDocRef.get();
                            }
                            
                            const userData = userDoc.data();
                            if (userData.status === 'inactive') {
                                showLoginScreen();
                                getEl('approval-message').style.display = 'block';
                                firebase.auth().signOut();
                                return;
                            }
                            if (userData.status === 'blocked') {
                                showLoginScreen();
                                getEl('blocked-message').style.display = 'block';
                                firebase.auth().signOut();
                                return;
                            }
                            
                            currentUser = { uid: user.uid, ...userData };
                            console.log("User logged in:", currentUser);
                            logActivity(`User logged in.`);
                            await showApp();

                        } catch (e) {
                            console.error("Auth state change error:", e);
                            showNotification("Error loading user profile. Please try again.", true);
                            firebase.auth().signOut();
                        }
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLoginScreen();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
            }

            // --- FUNCTION DEFINITIONS (must be in scope) ---
            
            const clearForm = () => {
                const formHtml = `
                    <h2 class="text-2xl font-bold mb-4">Job File Entry</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="text" id="jfn" class="input-field" placeholder="Job File Number (AC/001/...)">
                        <input type="date" id="d" class="input-field">
                        <input type="text" id="po" class="input-field" placeholder="P.O. Number">
                        <input type="text" id="in" class="input-field" placeholder="Invoice Number">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div class="relative">
                            <input type="text" id="sh" class="input-field" placeholder="Shipper's Name">
                            <div id="sh-autocomplete" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="relative">
                            <input type="text" id="co" class="input-field" placeholder="Consignee's Name">
                             <div id="co-autocomplete" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="text" id="dsc" class="input-field" placeholder="Description of Goods">
                        <input type="text" id="pc" class="input-field" placeholder="No. of Pieces">
                        <input type="text" id="gw" class="input-field" placeholder="Gross Weight">
                        <input type="text" id="mawb" class="input-field" placeholder="MAWB/BL No.">
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Charges</h3>
                        <div id="charges-container" class="space-y-2"></div>
                        <button type="button" id="add-charge-btn" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium">+ Add New Charge</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                         <textarea id="re" class="input-field" rows="3" placeholder="Remarks"></textarea>
                        <div class="space-y-2">
                             <div id="total-cost" class="font-semibold">Total Cost: 0.000</div>
                             <div id="total-selling" class="font-semibold">Total Selling: 0.000</div>
                             <div id="total-profit" class="font-bold text-lg">Total Profit: 0.000</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 justify-end items-center border-t pt-4 mt-4">
                        <button type="button" id="clear-form-btn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">New</button>
                        <button type="button" id="save-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Save</button>
                        <button type="button" id="file-manager-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">File Manager</button>
                        <button type="button" id="analytics-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Analytics</button>
                    </div>
                `;
                getEl('job-file-form').innerHTML = formHtml;
                currentJobFile = null;
                attachFormEventListeners();
                loadChargeDescriptions();
                addChargeRow(); // Start with one empty charge row
            };

            const saveJobFile = async () => { /* ... */ }; // Placeholder for now

            // Event listener setup
            const attachFormEventListeners = () => {
                getEl('clear-form-btn').addEventListener('click', clearForm);
                getEl('save-btn').addEventListener('click', saveJobFile);
                getEl('file-manager-btn').addEventListener('click', openFileManager);
                getEl('analytics-btn').addEventListener('click', openAnalyticsDashboard);
                getEl('add-charge-btn').addEventListener('click', addChargeRow);

                getEl('charges-container').addEventListener('input', (e) => {
                    if (e.target.classList.contains('charge-cost') || e.target.classList.contains('charge-selling')) {
                        calculateTotals();
                    }
                });

                getEl('charges-container').addEventListener('click', (e) => {
                    if (e.target.closest('.remove-charge-btn')) {
                        e.target.closest('.charge-row').remove();
                        calculateTotals();
                    }
                });
            };

            const calculateTotals = () => { /* ... */ };
            const addChargeRow = () => { /* ... */ };
            const loadChargeDescriptions = () => { /* ... */ };
            const openFileManager = async () => { /* ... */ };
            const openAnalyticsDashboard = async () => { /* ... */ };
            const loadAllJobFilesForCache = async () => { /* ... */ };
            
            // Making functions globally accessible for onclick attributes
            // This is a bridge until all event listeners are programmatically added
            window.clearForm = clearForm;
            window.saveJobFile = saveJobFile;
            window.openFileManager = openFileManager;
            window.openAnalyticsDashboard = openAnalyticsDashboard;

            // --- EVENT LISTENERS BINDING ---
            getEl('auth-link').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthView(!isLoginView);
            });

            getEl('auth-btn').addEventListener('click', () => {
                const email = getEl('email-address').value;
                const password = getEl('password').value;
                if (isLoginView) {
                    handleLogin(email, password);
                } else {
                    const name = getEl('full-name').value;
                    handleSignUp(email, password, name);
                }
            });

            // Delegate events for the app container
            getEl('app-container').addEventListener('click', (e) => {
                if (e.target.id === 'logout-btn') handleLogout();
            });

        }); // END of DOMContentLoaded
    })(); // End of self-executing function
    </script>
</body>
</html>
