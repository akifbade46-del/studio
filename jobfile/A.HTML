
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem; /* Slightly larger radius */
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* Softer shadow */
        }
        @media (min-width: 640px) {
            .container {
                margin: 2rem auto;
                padding: 2.5rem; /* More padding on desktop */
            }
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Improved focus ring */
        }
        .input-field:disabled, .input-field[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
            color: #6b7280;
        }
        .table-cell {
            border: 1px solid #e5e7eb; /* Lighter border */
            padding: 0.5rem;
            position: relative;
        }
        @media (min-width: 640px) {
            .table-cell {
                padding: 0.75rem;
            }
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            padding: 1rem;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translate(-50%, 100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000;
            text-align: center;
        }
        #notification.show {
            transform: translate(-50%, 0); opacity: 1;
        }

        @page { size: A4; margin: 0.5cm; }
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-container, .no-print, #app-container, #login-screen { display: none !important; }
            #print-output, #public-view-container, #analytics-container { display: block !important; padding: 0 !important; margin: 0 !important; }
        }
        #print-output .print-table, #preview-modal .print-table, #analytics-container .analytics-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td,
        #preview-modal .print-table th, #preview-modal .print-table td,
        #analytics-container .analytics-table th, #analytics-container .analytics-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        #analytics-container .analytics-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field, #preview-modal .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only, #signup-name-field { display: none; }
        
        .stamp {
            position: absolute;
            top: -10px; right: -10px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(15deg);
            opacity: 0.8;
            display: none;
        }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }

        /* Autocomplete styles */
        .autocomplete-suggestions {
            border: 1px solid #d1d5db;
            border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 999;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        .autocomplete-suggestion.selected {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <img class="mx-auto h-24 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                 <div id="blocked-message" class="hidden p-4 text-center text-red-800 bg-red-100 rounded-lg">
                    Your account has been blocked by an administrator.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
                <div class="text-center mt-2 text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div id="main-container" class="container">
            <!-- Header Section -->
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center">
                    <img id="logo-container" class="h-16 w-auto mr-4" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
                </div>
                <div class="text-right w-full sm:w-auto">
                    <div class="flex items-center mb-2">
                        <label for="date" class="mr-2 font-semibold text-gray-700">Date:</label>
                        <input type="date" id="date" class="input-field w-full sm:w-40">
                    </div>
                    <div class="flex items-center">
                        <label for="po-number" class="mr-2 font-semibold text-gray-700">P.O. #:</label>
                        <input type="text" id="po-number" class="input-field w-full sm:w-40">
                    </div>
                </div>
            </header>
            
            <!-- User Info and Logout -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 bg-gray-50 p-2 rounded-md gap-2">
                <div class="text-sm text-center sm:text-left">
                    Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role" class="capitalize"></span>)
                </div>
                 <div class="flex-grow text-center">
                     <button onclick="openAnalyticsDashboard()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-md text-base">Analytics</button>
                 </div>
                <div>
                    <button id="activity-log-btn" class="admin-only bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Activity Log</button>
                    <button id="admin-panel-btn" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Admin Panel</button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Logout</button>
                </div>
            </div>
            
            <!-- Quick Stats Section -->
            <div id="quick-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-white">
                <div class="bg-green-500 p-4 rounded-lg shadow-md"><p class="font-semibold">Total Profit</p><p id="stat-total-profit" class="text-2xl font-bold">0.000</p></div>
                <div class="bg-blue-500 p-4 rounded-lg shadow-md"><p class="font-semibold">Jobs This Month</p><p id="stat-jobs-month" class="text-2xl font-bold">0</p></div>
                <div class="bg-purple-500 p-4 rounded-lg shadow-md"><p class="font-semibold">Average Profit</p><p id="stat-avg-profit" class="text-2xl font-bold">0.000</p></div>
            </div>
            
            <!-- Status Summary -->
            <div id="status-summary-main" class="mb-4"></div>

            <div id="checker-info-banner" class="checker-only hidden p-3 mb-4 text-center text-blue-800 bg-blue-100 rounded-lg">
                <strong>Note:</strong> Files must be checked before they can be approved or rejected by an admin.
            </div>

            <div id="rejection-banner" class="hidden p-3 mb-4 text-center text-red-800 bg-red-100 rounded-lg">
                <strong>This job file was rejected.</strong> Reason: <span id="rejection-reason"></span>
            </div>

            <!-- Form Fields -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                    <input type="text" id="job-file-no" class="input-field" placeholder="Enter a unique ID here...">
                </div>
                <div class="flex items-end space-x-8 pb-1">
                    <div>
                        <span class="font-semibold text-gray-700">Clearance</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Export"> Export</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Import"> Import</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Clearance"> Clearance</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Local Move"> Local Move</label>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Product Type</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Air Freight"> Air Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Sea Freight"> Sea Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Land Freight"> Land Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Others"> Others</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
                <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
                <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="relative">
                    <label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label>
                    <input type="text" id="shipper-name" class="input-field" autocomplete="off">
                    <div id="shipper-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div class="relative">
                    <label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label>
                    <input type="text" id="consignee-name" class="input-field" autocomplete="off">
                    <div id="consignee-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
                <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
                <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
                <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
                <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
                <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
                <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
                <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="sm:col-span-2">
                    <label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label>
                    <input type="text" id="description" class="input-field">
                </div>
                <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line / Trucking Co:</label><input type="text" id="carrier" class="input-field"></div>
                <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
                <div><label for="vessel-name" class="block mb-1 font-semibold text-gray-700">Vessel's Name:</label><input type="text" id="vessel-name" class="input-field"></div>
                <div><label for="flight-voyage-no" class="block mb-1 font-semibold text-gray-700">Flight / Voyage No.:</label><input type="text" id="flight-voyage-no" class="input-field"></div>
                <div><label for="container-no" class="block mb-1 font-semibold text-gray-700">Container No.:</label><input type="text" id="container-no" class="input-field"></div>
            </div>

            <!-- Charges Table -->
            <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-semibold text-gray-800">Charges</h2>
                 <div>
                     <button onclick="openChargeManager()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105 mr-2">Manage Descriptions</button>
                     <button onclick="suggestCharges()" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105">Suggest Charges ✨</button>
                 </div>
            </div>
            <div class="mb-6 overflow-x-auto border border-gray-200 rounded-lg">
                <table id="charges-table" class="w-full border-collapse">
                    <!-- JS will populate this -->
                </table>
            </div>
            <div class="text-right mb-6">
                 <button onclick="addChargeRow()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Add Charge</button>
            </div>

            <!-- Remarks Section -->
            <div class="flex justify-between items-center mb-2">
                <label for="remarks" class="block font-semibold text-gray-700">REMARKS:</label>
            </div>
            <div class="mb-8">
                <textarea id="remarks" rows="4" class="input-field w-full"></textarea>
            </div>

            <!-- Creator/Editor Info -->
            <div id="file-info" class="text-xs text-gray-500 mb-4 border-t pt-4">
                <span id="created-by-info"></span>
                <span id="last-updated-by-info" class="ml-4"></span>
            </div>

            <!-- Footer Section -->
            <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t items-end">
                <div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input type="text" id="prepared-by" class="input-field bg-gray-100" readonly></div>
                <div class="relative">
                    <div id="checked-stamp" class="stamp stamp-checked">Checked</div>
                    <label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label>
                    <input type="text" id="checked-by" class="input-field bg-gray-100" readonly>
                    <button id="check-btn" class="checker-only mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Check Job File</button>
                </div>
                <div class="relative">
                    <div id="approved-stamp" class="stamp stamp-approved">Approved</div>
                    <div id="rejected-stamp" class="stamp stamp-rejected">Rejected</div>
                    <label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label>
                    <input type="text" id="approved-by" class="input-field bg-gray-100" readonly>
                    <div id="approval-buttons" class="admin-only mt-2 w-full flex gap-2">
                        <button id="approve-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Approve</button>
                        <button id="reject-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Reject</button>
                    </div>
                </div>
            </footer>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print flex flex-wrap justify-center gap-2 sm:gap-4">
                 <button onclick="openClientManager()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                     <span>Clients</span>
                 </button>
                 <button onclick="openFileManager()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V7a1 1 0 00-1-1h-5.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 005.586 3H3zm2 5a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                     <span>File Manager</span>
                 </button>
                 <button onclick="saveJobFile()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586l-1.293-1.293zM5 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" /></svg>
                     <span>Save</span>
                 </button>
                 <button onclick="clearForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                     <span>Clear</span>
                 </button>
                 <button onclick="printPreview()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v-2a1 1 0 011-1h8a1 1 0 011 1v2h1a2 2 0 002-2v-3a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                     <span>Preview / Print</span>
                 </button>
                 <button onclick="openRecycleBin()" class="admin-only bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                     <span>Recycle Bin</span>
                 </button>
            </div>

        </div>
    </div>

    <!-- This container is hidden by default and will be populated for printing/preview -->
    <div id="print-output" class="hidden"></div>
    
    <!-- This container is for the public QR code view -->
    <div id="public-view-container"></div>

    <!-- Analytics Full-Screen Page -->
    <div id="analytics-container" class="hidden">
    </div>


    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="overlay">
        <div class="modal-content max-w-5xl"> <!-- Increased width for filters -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">File Manager</h3>
                <button onclick="closeModal('file-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                <div class="md:col-span-2"><label for="search-bar" class="block text-sm font-medium text-gray-700">Search (Job No, Shipper, Consignee)</label><input type="text" id="search-bar" class="input-field mt-1" /></div>
                <div><label for="filter-status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="filter-status" class="input-field mt-1">
                        <option value="">All</option><option value="pending">Pending</option><option value="checked">Checked</option><option value="approved">Approved</option><option value="rejected">Rejected</option>
                    </select>
                </div>
                <div><label for="filter-date-from" class="block text-sm font-medium text-gray-700">Date Range</label>
                    <div class="flex items-center mt-1">
                        <input type="date" id="filter-date-from" class="input-field" /><span class="mx-2">to</span><input type="date" id="filter-date-to" class="input-field" />
                    </div>
                </div>
            </div>
            <div class="text-right mb-4">
               <button id="clear-filters-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Clear Filters</button>
            </div>
            <div id="status-summary-file-manager" class="mb-4"></div>
            <div id="job-files-list" class="space-y-3 max-h-[50vh] overflow-y-auto border p-2 rounded-md bg-gray-50"></div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-delete-modal" class="overlay">
        <div class="modal-content max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="confirm-delete-message" class="mb-6">Do you really want to delete this file? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('confirm-delete-modal')" class="bg-gray-300 py-2 px-6 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 no-print gap-2">
                <h3 class="text-2xl font-bold">Job File Preview</h3>
                <div>
                    <button onclick="printPage()" title="Print Preview" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">🖨️ Print</button>
                    <button onclick="closeModal('preview-modal')" class="text-gray-500 hover:text-gray-800 text-3xl align-middle">&times;</button>
                </div>
            </div>
            <div id="preview-body"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Admin Panel</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
        
            <!-- User Management -->
            <div class="border rounded-lg p-4">
                <h4 class="text-lg font-semibold mb-2">User Management (Firebase)</h4>
                <div id="user-list" class="space-y-2 max-h-[40vh] overflow-y-auto"></div>
                <div class="text-right mt-4">
                    <button onclick="saveUserChanges()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save User Changes</button>
                </div>
            </div>
        
             <!-- Data Backup & Restore (Local) -->
            <div class="border rounded-lg p-4 mt-6">
                <h4 class="text-lg font-semibold mb-3">Data Backup & Restore</h4>
                <p class="text-sm text-gray-600 mb-4">Backup all job files to a single JSON file, or restore from the `BACKUP/` directory on the server.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="backupAllData()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        Backup All Data
                    </button>
                     <button onclick="restoreFromBackup()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707-1.707A1 1 0 00.879 11L5.879 16a1 1 0 001.414 0L12.293 11a1 1 0 00-1.414-1.414L9 11.586V8a4 4 0 118 0v2a1 1 0 102 0V8a6 6 0 00-6-6z" /></svg>
                         Restore from Backup
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div id="reject-reason-modal" class="overlay">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-bold mb-4">Rejection Reason</h3>
            <p class="mb-4">Please provide a reason for rejecting this job file.</p>
            <textarea id="rejection-reason-input" class="input-field w-full" rows="3"></textarea>
            <div class="text-right mt-6 space-x-2">
                <button onclick="closeModal('reject-reason-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-reject-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm Rejection</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Reset Password</h3>
                <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <p class="mb-4 text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
            <div>
                <label for="reset-email" class="sr-only">Email address</label>
                <input id="reset-email" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
            </div>
            <div class="text-right mt-6">
                <button id="send-reset-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                    Send Password Reset Link
                </button>
            </div>
        </div>
    </div>

    <!-- Client Manager Modal -->
    <div id="client-manager-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Client Management (Firebase)</h3>
                <button onclick="closeModal('client-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Add/Edit Client Form -->
                <div class="md:col-span-1">
                    <h4 id="client-form-title" class="text-xl font-semibold mb-4">Add New Client</h4>
                    <form id="client-form" class="space-y-4">
                        <input type="hidden" id="client-id">
                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                            <input type="text" id="client-name" class="input-field mt-1" required>
                        </div>
                        <div>
                            <label for="client-address" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="client-address" rows="2" class="input-field mt-1"></textarea>
                        </div>
                        <div>
                            <label for="client-contact-person" class="block text-sm font-medium text-gray-700">Contact Person</label>
                            <input type="text" id="client-contact-person" class="input-field mt-1">
                        </div>
                        <div>
                            <label for="client-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="client-phone" class="input-field mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Type</label>
                            <select id="client-type" class="input-field mt-1">
                                <option value="Shipper">Shipper</option>
                                <option value="Consignee">Consignee</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save Client</button>
                            <button type="button" id="clear-client-form-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Clear</button>
                        </div>
                    </form>
                </div>
                <!-- Client List -->
                <div class="md:col-span-2">
                    <input type="text" id="client-search-bar" class="input-field mb-4" placeholder="Search clients...">
                    <div id="client-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- Client list will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Charge Manager Modal -->
    <div id="charge-manager-modal" class="overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Manage Charge Descriptions</h3>
                <button onclick="closeModal('charge-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="text-lg font-semibold mb-2">Add New Description</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-charge-description" class="input-field" placeholder="E.g., Customs Duty">
                        <button onclick="saveChargeDescription()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2">Existing Descriptions</h4>
                    <div id="charge-description-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- JS will populate this list -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Log Modal -->
    <div id="activity-log-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">User Activity Log</h3>
                <button onclick="closeModal('activity-log-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="table-cell font-semibold text-left">User Name</th>
                            <th class="table-cell font-semibold text-left">Job File No.</th>
                            <th class="table-cell font-semibold text-left">Time Opened</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User-Specific Jobs Modal (Analytics) -->
    <div id="user-jobs-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-jobs-modal-title" class="text-2xl font-bold">User's Job Files</h3>
                <button onclick="closeModal('user-jobs-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="user-jobs-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>

    <!-- Recycle Bin Modal -->
    <div id="recycle-bin-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Recycle Bin</h3>
                <button onclick="closeModal('recycle-bin-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="recycle-bin-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global variables ---
        let db, auth;
        let currentUser = null;
        let jobFilesCache = []; // Caches job files from Hostinger
        let clientsCache = [];  // Caches clients from Firebase
        let allUsersCache = []; // Caches all users from Firebase for Admin Panel
        let chargeDescriptions = [];
        let analyticsDataCache = null; // Caches full data for analytics
        let currentJobFile = null; // Holds the currently loaded job file data
        let profitChartInstance, salesmanChartInstance;
        let fileIdToReject = null;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, 'users', user.uid);
                        let userDoc = await getDoc(userDocRef);
                        
                        if (!userDoc.exists()) {
                            const usersCollectionRef = collection(db, 'users');
                            const userQuerySnapshot = await getDocs(usersCollectionRef);
                            const isFirstUser = userQuerySnapshot.size === 0;

                            const newUser = {
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                role: isFirstUser ? 'admin' : 'user',
                                status: isFirstUser ? 'active' : 'inactive',
                                createdAt: serverTimestamp()
                            };
                            await setDoc(userDocRef, newUser);
                            userDoc = await getDoc(userDocRef);
                        }
                        
                        const userData = userDoc.data();
                        
                        if (userData.status === 'inactive') {
                            showLogin();
                            document.getElementById('approval-message').style.display = 'block';
                            document.getElementById('blocked-message').style.display = 'none';
                            signOut(auth);
                            return;
                        }

                        if (userData.status === 'blocked') {
                            showLogin();
                            document.getElementById('approval-message').style.display = 'none';
                            document.getElementById('blocked-message').style.display = 'block';
                            signOut(auth);
                            return;
                        }
                        
                        currentUser = { uid: user.uid, ...userData };
                        console.log("User logged in:", currentUser);
                        await showApp();
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
            }
        }
        
        // --- Central API Handler ---
        async function handleApiRequest(script, options, successMessage, errorMessage) {
            showLoader();
            try {
                const response = await fetch(script, options);
                if (!response.ok) { // Check for non-2xx responses
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}: ${errorText}`);
                }
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'An unknown error occurred.');
                }
                if (successMessage) showNotification(successMessage);
                hideLoader();
                return result;
            } catch (error) {
                console.error(`Error in ${script}:`, error);
                showNotification(errorMessage + ` (${error.message})`, true);
                hideLoader();
                return null;
            }
        }

        // --- Authentication Logic ---
        async function handleSignUp(email, password, displayName) {
            showLoader();
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification("Account created! Please wait for admin approval.", false);
                await signOut(auth);
                toggleAuthView(true);
            } catch (error) {
                console.error("Sign up error:", error);
                showNotification(error.message, true);
            }
            hideLoader();
        }

        async function handleLogin(email, password) {
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                let message = "Login failed. Please check your email and password.";
                if (['auth/user-not-found', 'auth/wrong-password', 'auth/invalid-credential'].includes(error.code)) {
                    message = "Incorrect email or password. Please try again or reset your password.";
                }
                showNotification(message, true);
            }
            hideLoader();
        }
        
        async function handleForgotPassword() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email) { showNotification("Please enter your email address.", true); return; }
            showLoader();
            try {
                await sendPasswordResetEmail(auth, email);
                hideLoader();
                closeModal('forgot-password-modal');
                showNotification("Password reset link sent! Check your email inbox.", false);
            } catch (error) {
                hideLoader();
                console.error("Password reset error:", error);
                let message = "Could not send reset link. Please try again.";
                if(error.code === 'auth/user-not-found'){ message = "No account found with this email address."; }
                showNotification(message, true);
            }
        }

        function handleLogout() { signOut(auth); }

        // --- DATA HANDLING (Hostinger via PHP) ---
        async function saveJobFile() {
            const jobFileNoInput = document.getElementById('job-file-no');
            const jobFileNo = jobFileNoInput.value.trim();
            const isUpdating = jobFileNoInput.disabled;

            if (!jobFileNo) { showNotification("Please enter a Job File No.", true); return; }
            
            const data = getFormData();
            data.totalCost = parseFloat(document.getElementById('total-cost').textContent) || 0;
            data.totalSelling = parseFloat(document.getElementById('total-selling').textContent) || 0;
            data.totalProfit = parseFloat(document.getElementById('total-profit').textContent) || 0;
            data.lastUpdatedBy = currentUser.displayName;
            data.updatedAt = new Date().toISOString();
            
            if (isUpdating && currentJobFile) { // Merge with existing data
                data.createdBy = currentJobFile.createdBy || currentUser.displayName;
                data.createdAt = currentJobFile.createdAt || new Date().toISOString();
                 // Reset status on edit
                if (currentJobFile.status === 'approved' || currentJobFile.status === 'checked') {
                    data.status = 'pending';
                    data.checkedBy = null; data.checkedAt = null;
                    data.approvedBy = null; data.approvedAt = null;
                    data.rejectionReason = null; data.rejectedBy = null; data.rejectedAt = null;
                    showNotification("File modified. Re-approval is now required.");
                }
            } else {
                data.createdBy = currentUser.displayName;
                data.createdAt = new Date().toISOString();
                data.status = 'pending';
            }
            
            const result = await handleApiRequest('save-jobfile.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: jobFileNo.replace(/\//g, '_') + '.json', data: data, isUpdating: isUpdating }),
            }, "Job file saved successfully!", "Error saving job file.");

            if(result) {
                jobFileNoInput.disabled = true;
                currentJobFile = result.data; // Use returned data
                populateFormFromData(currentJobFile); // Refresh form with new status
            }
        }
        
        async function loadAllJobFilesForCache() {
            const result = await handleApiRequest('list-jobfiles.php?full=true&all=true', { method: 'GET' }, null, "Could not list job files.");
            if (result && result.files) {
                jobFilesCache = result.files;
                updateMainPageStats();
                return true;
            }
            return false;
        }

        async function loadJobFileById(docId) {
            const filename = docId + '.json';
            const result = await handleApiRequest(`load-jobfile.php?file=${filename}`, { method: 'GET' }, null, "Could not load job file.");
            if (result && result.data) {
                populateFormFromData(result.data);
                logUserActivity(result.data.jfn);
                closeAllModals();
                showNotification("Job file loaded successfully.");
            }
        }
        
        async function updateStatus(docId, status, reason = null) {
            const jobFileId = docId || (currentJobFile ? currentJobFile.jfn.replace(/\//g, '_') : null);
            if (!jobFileId) { showNotification("No job file loaded to update status.", true); return; }
            
            const payload = { filename: jobFileId + '.json', status, user: currentUser.displayName };
            if (reason) payload.reason = reason;

            const result = await handleApiRequest('update-status.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            }, `Job file ${status}!`, `Failed to update status.`);
            
            if (result && result.data) {
                populateFormFromData(result.data);
                closeModal('reject-reason-modal');
            }
        }

        async function checkJobFile(docId = null, fromModal = false) { 
            await updateStatus(docId, 'checked');
            if(fromModal) await openFileManager(true); // Force reload
        }
        async function approveJobFile(docId = null, fromModal = false) { 
            await updateStatus(docId, 'approved'); 
            if(fromModal) await openFileManager(true); // Force reload
        }
        function promptForRejection(docId = null) { 
            fileIdToReject = docId || (currentJobFile ? currentJobFile.jfn.replace(/\//g, '_') : null);
            if (!fileIdToReject) { showNotification("No file specified to reject.", true); return; }
            openModal('reject-reason-modal');
        }
        async function rejectJobFile() {
            const reason = document.getElementById('rejection-reason-input').value;
            if (!reason) { showNotification("Please provide a reason for rejection.", true); return; }
            await updateStatus(fileIdToReject, 'rejected', reason);
        }
        
        function confirmDelete(docId, type = 'jobfile') {
             if (currentUser.role !== 'admin') { showNotification("Only admins can delete.", true); return; }
            
            let message, title;
            let handler = () => {};
            
            if (type === 'jobfile' || type === 'recycle') {
                const isPermanent = type === 'recycle';
                const fileCache = isPermanent ? jobFilesCache.filter(f => f.isDeleted) : jobFilesCache;
                const fileToDelete = fileCache.find(f => f.jfn && f.jfn.replace(/\//g, '_') === docId);
                title = isPermanent ? 'Confirm Permanent Deletion' : 'Confirm Deletion';
                message = isPermanent ? `This will permanently delete the file "${fileToDelete?.jfn || docId}". This action CANNOT be undone.`
                                      : `Are you sure you want to delete the file "${fileToDelete?.jfn || docId}"? This will move it to the recycle bin.`;
                handler = () => deleteJobFile(docId, isPermanent);
            } else if (type === 'client') {
                const client = clientsCache.find(c => c.id === docId);
                title = 'Confirm Client Deletion';
                message = `Are you sure you want to delete the client "${client?.name || docId}"?`;
                handler = () => deleteClient(docId);
            } else {
                return;
            }

            const modal = document.getElementById('confirm-delete-modal');
            modal.querySelector('h3').textContent = title;
            modal.querySelector('#confirm-delete-message').innerHTML = message;
            
            const okButton = modal.querySelector('#confirm-delete-btn');
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);
            newOkButton.addEventListener('click', handler);

            openModal('confirm-delete-modal', true);
        }
        
        async function deleteJobFile(docId, isPermanent) {
            closeModal('confirm-delete-modal');
            const result = await handleApiRequest(`delete-jobfile.php?file=${docId}.json&permanent=${isPermanent ? '1' : '0'}&user=${currentUser.displayName}`, { method: 'GET' }, 
                isPermanent ? "File permanently deleted." : "File moved to recycle bin.", 
                "Failed to delete file.");
            if (result) {
                if(isPermanent) openRecycleBin(true); else openFileManager(true);
            }
        }
        
        async function restoreJobFile(docId) {
            const result = await handleApiRequest(`restore-jobfile.php?file=${docId}.json`, { method: 'GET' }, 
                "File restored successfully.", "Failed to restore file.");
            if(result) {
                closeModal('confirm-delete-modal');
                openRecycleBin(true); // Refresh recycle bin view
            }
        }

        // --- UI Functions ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        async function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'none');
            
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
            } else if (currentUser.role === 'checker') {
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
            }
            if(currentUser.role === 'checker' || currentUser.role === 'admin'){
                document.getElementById('checker-info-banner').style.display = 'block';
            }
            
            clearForm();
            await loadAllJobFilesForCache();
            loadClients();
        }

        function closeAllModals() {
            document.querySelectorAll('.overlay').forEach(modal => modal.classList.remove('visible'));
        }

        function openModal(id, keepParent = false) {
            const modal = document.getElementById(id);
            if (!modal) return;
            if (keepParent) {
                 const highestZ = Array.from(document.querySelectorAll('.overlay.visible'))
                    .reduce((max, el) => Math.max(max, parseInt(window.getComputedStyle(el).zIndex || '1000', 10)), 1000);
                modal.style.zIndex = `${highestZ + 10}`;
            } else {
                closeAllModals();
            }
            modal.classList.add('visible');
        }
        function closeModal(id) { document.getElementById(id)?.classList.remove('visible'); }
        
        function clearForm() {
            currentJobFile = null;
            const form = document.querySelector('#main-container');
            form.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(input => input.value = '');
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('job-file-no').disabled = false;
            populateTable();
            calculate();
            
            document.getElementById('prepared-by').value = currentUser.displayName;
            
            document.getElementById('created-by-info').textContent = '';
            document.getElementById('last-updated-by-info').textContent = '';
            document.getElementById('checked-stamp').style.display = 'none';
            document.getElementById('approved-stamp').style.display = 'none';
            document.getElementById('rejected-stamp').style.display = 'none';
            document.getElementById('rejection-banner').style.display = 'none';

            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('approval-buttons').style.display = 'none';

            showNotification("Form cleared.");
        }

        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 3000);
        }

        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const description = row.querySelector('.description-input').value.trim();
                const cost = row.querySelector('.cost-input').value;
                const selling = row.querySelector('.selling-input').value;
                if (description && (cost || selling)) {
                    charges.push({ l: description, c: cost || '0', s: selling || '0', n: row.querySelector('.notes-input').value || '' });
                }
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'),
            };
        }
        
        function populateFormFromData(data) {
            clearForm(); // Start with a clean slate
            currentJobFile = data;
            
            const setVal = (id, value) => { if(document.getElementById(id)) document.getElementById(id).value = value || '' };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-${type}]`).forEach(el => { el.checked = (values || []).includes(el.dataset[type]); });
            };

            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            document.getElementById('job-file-no').disabled = true;

            setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); 
            setVal('prepared-by', data.pb || data.createdBy || '');
            
            document.getElementById('created-by-info').textContent = data.createdBy ? `Created by: ${data.createdBy} on ${new Date(data.createdAt).toLocaleDateString()}` : '';
            document.getElementById('last-updated-by-info').textContent = data.lastUpdatedBy ? `Last updated by: ${data.lastUpdatedBy} on ${new Date(data.updatedAt).toLocaleString()}` : '';

            setChecked('clearance', data.cl);
            setChecked('product', data.pt);

            populateTable();
            if (data.ch && data.ch.length > 0) {
                document.getElementById('charges-table-body').innerHTML = '';
                data.ch.forEach(addChargeRow);
            }
            calculate();

            // Status handling
            const isAdmin = currentUser.role === 'admin';
            const isChecker = ['admin', 'checker'].includes(currentUser.role);
            
            if (data.status === 'checked') {
                document.getElementById('checked-stamp').style.display = 'block';
                setVal('checked-by', `${data.checkedBy} on ${new Date(data.checkedAt).toLocaleDateString()}`);
                if (isAdmin) document.getElementById('approval-buttons').style.display = 'flex';
            } else if (data.status === 'approved') {
                document.getElementById('approved-stamp').style.display = 'block';
                document.getElementById('checked-stamp').style.display = 'block';
                setVal('checked-by', `${data.checkedBy} on ${new Date(data.checkedAt).toLocaleDateString()}`);
                setVal('approved-by', `${data.approvedBy} on ${new Date(data.approvedAt).toLocaleDateString()}`);
            } else if (data.status === 'rejected') {
                document.getElementById('rejected-stamp').style.display = 'block';
                document.getElementById('rejection-banner').style.display = 'block';
                document.getElementById('rejection-reason').textContent = data.rejectionReason || '';
                setVal('approved-by', `Rejected by ${data.rejectedBy} on ${new Date(data.rejectedAt).toLocaleDateString()}`);
            } else { // Pending
                if (isChecker) document.getElementById('check-btn').style.display = 'block';
            }
        }
        
        function printPage() {
            window.print();
        }

        async function printPreview() {
            const data = getFormData();
            data.totalCost = parseFloat(document.getElementById('total-cost').textContent);
            data.totalSelling = parseFloat(document.getElementById('total-selling').textContent);
            data.totalProfit = parseFloat(document.getElementById('total-profit').textContent);
            
            const previewHTML = getPrintViewHtml(data);
            document.getElementById('preview-body').innerHTML = previewHTML;
            document.getElementById('print-output').innerHTML = previewHTML;

            const qrContainer = document.getElementById('preview-body').querySelector('.qrcode-container');
            if (qrContainer && data.jfn) {
                qrContainer.innerHTML = '';
                const publicUrl = window.location.href.split('?')[0].replace('A.HTML', '') + `public.php?jobId=${encodeURIComponent(data.jfn)}`;
                new QRCode(qrContainer, { text: publicUrl, width: 96, height: 96 });
            }
            openModal('preview-modal');
        }
        
        function getPrintViewHtml(data) {
            const totalCost = data.totalCost || 0;
            const totalSelling = data.totalSelling || 0;
            const totalProfit = data.totalProfit || 0;
            
            let chargesHtml = (data.ch || []).map(c => `
                <tr>
                    <td class="px-2 py-1 border">${c.l}</td>
                    <td class="px-2 py-1 border text-right">${parseFloat(c.c || 0).toFixed(3)}</td>
                    <td class="px-2 py-1 border text-right">${parseFloat(c.s || 0).toFixed(3)}</td>
                    <td class="px-2 py-1 border text-right">${(parseFloat(c.s || 0) - parseFloat(c.c || 0)).toFixed(3)}</td>
                    <td class="px-2 py-1 border">${c.n || ''}</td>
                </tr>
            `).join('');

            return `<div class="p-4 bg-white text-sm">
                <div class="flex justify-between items-start mb-4">
                    <img class="h-16 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                    <div class="text-right">
                        <h1 class="text-2xl font-bold">JOB FILE</h1>
                        <p><strong>Date:</strong> ${data.d || ''}</p>
                        <p><strong>P.O. #:</strong> ${data.po || ''}</p>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div><strong class="font-semibold">Job File No:</strong><div class="print-field">${data.jfn || ''}</div></div>
                    <div class="col-span-3"><strong class="font-semibold">Clearance:</strong><div class="print-field">${(data.cl || []).join(', ')}</div></div>
                    <div><strong class="font-semibold">Invoice No:</strong><div class="print-field">${data.in || ''}</div></div>
                    <div><strong class="font-semibold">Billing Date:</strong><div class="print-field">${data.bd || ''}</div></div>
                    <div class="col-span-2"><strong class="font-semibold">Product Type:</strong><div class="print-field">${(data.pt || []).join(', ')}</div></div>
                    <div class="col-span-2"><strong class="font-semibold">Shipper's Name:</strong><div class="print-field">${data.sh || ''}</div></div>
                    <div class="col-span-2"><strong class="font-semibold">Consignee's Name:</strong><div class="print-field">${data.co || ''}</div></div>
                    <div><strong class="font-semibold">MAWB/OBL/TCN No.:</strong><div class="print-field">${data.mawb || ''}</div></div>
                    <div><strong class="font-semibold">HAWB/HBL:</strong><div class="print-field">${data.hawb || ''}</div></div>
                    <div><strong class="font-semibold">Origin:</strong><div class="print-field">${data.or || ''}</div></div>
                    <div><strong class="font-semibold">Destination:</strong><div class="print-field">${data.de || ''}</div></div>
                    <div><strong class="font-semibold">No. of Pieces:</strong><div class="print-field">${data.pc || ''}</div></div>
                    <div><strong class="font-semibold">Gross Weight:</strong><div class="print-field">${data.gw || ''}</div></div>
                    <div><strong class="font-semibold">Volume Weight:</strong><div class="print-field">${data.vw || ''}</div></div>
                    <div><strong class="font-semibold">Salesman:</strong><div class="print-field">${data.sm || ''}</div></div>
                     <div class="col-span-4"><strong class="font-semibold">Description:</strong><div class="print-field">${data.dsc || ''}</div></div>
                </div>

                <h3 class="font-bold text-lg mb-2">Charges</h3>
                <table class="w-full border-collapse border print-table mb-4">
                    <thead><tr class="bg-gray-100">
                        <th class="px-2 py-1 border font-semibold">Description</th>
                        <th class="px-2 py-1 border font-semibold">Cost</th>
                        <th class="px-2 py-1 border font-semibold">Selling</th>
                        <th class="px-2 py-1 border font-semibold">Profit</th>
                        <th class="px-2 py-1 border font-semibold">Notes</th>
                    </tr></thead>
                    <tbody>${chargesHtml}</tbody>
                    <tfoot><tr class="bg-gray-100 font-bold">
                        <td class="px-2 py-1 border text-right">TOTAL</td>
                        <td class="px-2 py-1 border text-right">${totalCost.toFixed(3)}</td>
                        <td class="px-2 py-1 border text-right">${totalSelling.toFixed(3)}</td>
                        <td class="px-2 py-1 border text-right">${totalProfit.toFixed(3)}</td>
                        <td class="px-2 py-1 border"></td>
                    </tr></tfoot>
                </table>
                <div class="mb-4"><strong class="font-semibold">REMARKS:</strong><div class="print-field">${data.re || ''}</div></div>
                 <footer class="grid grid-cols-3 gap-8 pt-6 border-t items-end text-center">
                    <div><p class="font-semibold">PREPARED BY</p><div class="print-field mt-2">${data.pb || data.createdBy || ''}</div></div>
                    <div><p class="font-semibold">CHECKED BY</p><div class="print-field mt-2">${data.checkedBy ? `${data.checkedBy} on ${new Date(data.checkedAt).toLocaleDateString()}` : ''}</div></div>
                    <div><p class="font-semibold">APPROVED BY</p><div class="print-field mt-2">${data.approvedBy ? `${data.approvedBy} on ${new Date(data.approvedAt).toLocaleDateString()}` : ''}</div></div>
                </footer>
                 <div class="flex justify-end mt-4"><div class="qrcode-container"></div></div>
            </div>`;
        }

        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(3);
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(3);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(3);
            document.getElementById('total-profit').textContent = totalProfit.toFixed(3);
        }
        
        function populateTable() {
            const table = document.getElementById('charges-table');
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-100">
                        <th class="table-cell font-semibold w-2/5">Description</th>
                        <th class="table-cell font-semibold">Cost</th>
                        <th class="table-cell font-semibold">Selling</th>
                        <th class="table-cell font-semibold">Profit</th>
                        <th class="table-cell font-semibold">Notes</th>
                         <th class="table-cell font-semibold"></th>
                    </tr>
                </thead>
                <tbody id="charges-table-body"></tbody>
                <tfoot>
                     <tr id="total-row" class="bg-gray-100 font-bold">
                        <td class="table-cell text-right">TOTAL:</td>
                        <td id="total-cost" class="table-cell text-right">0.000</td>
                        <td id="total-selling" class="table-cell text-right">0.000</td>
                        <td id="total-profit" class="table-cell text-right">0.000</td>
                        <td class="table-cell" colspan="2"></td>
                    </tr>
                </tfoot>
            `;
            const tableBody = document.getElementById('charges-table-body');
            tableBody.addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) { calculate(); }
            });
            for(let i=0; i<5; i++) addChargeRow();
        }

        function addChargeRow(data = {}) {
            const tableBody = document.getElementById('charges-table-body');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td class="table-cell relative">
                    <input type="text" class="description-input input-field" value="${data.l || ''}" autocomplete="off">
                    <div class="autocomplete-suggestions hidden"></div>
                </td>
                <td class="table-cell"><input type="number" step="0.001" class="cost-input input-field" value="${data.c || ''}"></td>
                <td class="table-cell"><input type="number" step="0.001" class="selling-input input-field" value="${data.s || ''}"></td>
                <td class="table-cell profit-output bg-gray-50 text-right">${((data.s || 0) - (data.c || 0)).toFixed(3)}</td>
                <td class="table-cell"><input type="text" class="notes-input input-field" value="${data.n || ''}"></td>
                <td class="table-cell text-center"><button class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></td>
            `;

            const descriptionInput = newRow.querySelector('.description-input');
            setupChargeAutocomplete(descriptionInput);
            
            const deleteButton = newRow.querySelector('button');
            deleteButton.addEventListener('click', () => { newRow.remove(); calculate(); });

            tableBody.appendChild(newRow);
        }
        
        function toggleAuthView(isLogin) {
            const nameField = document.getElementById('signup-name-field');
            const emailField = document.getElementById('email-address');
            
            document.getElementById('auth-title').textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = isLogin ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = isLogin ? 'Create a new account' : 'Already have an account? Sign in';
            nameField.style.display = isLogin ? 'none' : 'block';
            emailField.classList.toggle('rounded-t-md', !isLogin);
            document.getElementById('approval-message').style.display = 'none';
        }

        async function openFileManager(forceReload = false) {
            showLoader();
            let result;
            if (forceReload || jobFilesCache.length === 0) {
                 result = await handleApiRequest('list-jobfiles.php', { method: 'GET' }, null, "Could not list job files.");
                 if (result && result.files) {
                     jobFilesCache = result.files;
                 } else {
                     hideLoader();
                     return;
                 }
            }
            hideLoader();
            applyFiltersAndDisplay();
            openModal('file-manager-modal');
        }

        function applyFiltersAndDisplay() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const fromDate = document.getElementById('filter-date-from').value;
            const toDate = document.getElementById('filter-date-to').value;

            let filtered = jobFilesCache.filter(file => {
                if (!file || !file.jfn || file.isDeleted) return false;
                const searchData = [file.jfn, file.sh, file.co, file.mawb].join(' ').toLowerCase();
                if (searchTerm && !searchData.includes(searchTerm)) return false;
                if (statusFilter && file.status !== statusFilter) return false;
                if (fromDate && (file.d || '') < fromDate) return false;
                if (toDate && (file.d || '') > toDate) return false;
                return true;
            });
            filtered.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            displayJobFiles(filtered, 'job-files-list');
            updateStatusSummary('status-summary-file-manager', filtered);
        }

        function displayJobFiles(files, elementId, isRecycleBin = false) {
             const list = document.getElementById(elementId);
             if (!files || files.length === 0) {
                 list.innerHTML = `<p class="text-gray-500 text-center p-4">No job files found.</p>`;
                 return;
            }
            const filesHtml = files.map(file => {
                const docId = file.jfn.replace(/\//g, '_');
                let buttons = '';
                if(isRecycleBin){
                    buttons = `
                        <button onclick="restoreJobFile('${docId}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Restore</button>
                        <button onclick="confirmDelete('${docId}', 'recycle')" class="bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-3 rounded text-sm">Delete Forever</button>
                    `;
                } else {
                    const deleteButton = currentUser.role === 'admin' ? `<button onclick="confirmDelete('${docId}', 'jobfile')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Delete</button>` : '';
                    buttons = `
                        <button onclick="previewJobFileById('${docId}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm">Preview</button>
                        <button onclick="loadJobFileById('${docId}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Load</button>
                        ${deleteButton}
                    `;
                }
                const deletedInfo = isRecycleBin ? `<p class="text-xs text-red-400">Deleted by: ${file.deletedBy} on ${new Date(file.deletedAt).toLocaleString()}</p>` : `<p class="text-xs text-gray-400">Last Updated: ${file.updatedAt ? new Date(file.updatedAt).toLocaleString() : 'N/A'}</p>`;

                return `
                    <div class="job-file-item border p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-gray-50 hover:bg-gray-100 gap-2">
                        <div class="text-center sm:text-left">
                            <p class="font-bold text-indigo-700">${file.jfn || 'No ID'}</p>
                            <p class="text-sm text-gray-600">Shipper: ${file.sh || 'N/A'} | Consignee: ${file.co || 'N/A'}</p>
                            ${deletedInfo}
                        </div>
                        <div class="space-x-2 flex-shrink-0">
                            ${buttons}
                        </div>
                    </div>
                `;
            }).join('');
            list.innerHTML = filesHtml;
        }
        
        async function previewJobFileById(docId) {
             const filename = docId + '.json';
            const result = await handleApiRequest(`load-jobfile.php?file=${filename}`, { method: 'GET' }, null, "Could not load file for preview.");
            if (result && result.data) {
                 const previewHTML = getPrintViewHtml(result.data);
                 document.getElementById('preview-body').innerHTML = previewHTML;
                 openModal('preview-modal');
            }
        }
        
        function updateStatusSummary(elementId, files) {
            const summaryEl = document.getElementById(elementId);
            if (!summaryEl) return;
            const counts = files.reduce((acc, file) => {
                const status = file.status || 'pending';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            summaryEl.innerHTML = `
                <div class="flex flex-wrap justify-center gap-2 text-xs">
                    <span class="font-bold">Total: ${files.length}</span>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full cursor-pointer" onclick="showStatusJobs('pending')">Pending: ${counts['pending'] || 0}</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full cursor-pointer" onclick="showStatusJobs('checked')">Checked: ${counts['checked'] || 0}</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full cursor-pointer" onclick="showStatusJobs('approved')">Approved: ${counts['approved'] || 0}</span>
                    <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full cursor-pointer" onclick="showStatusJobs('rejected')">Rejected: ${counts['rejected'] || 0}</span>
                </div>
            `;
        };
        
        function updateMainPageStats() {
            if (!jobFilesCache) return;
            const files = jobFilesCache.filter(f => !f.isDeleted);
            if (files.length === 0) return;

            const totalProfit = files.reduce((sum, file) => sum + (file.totalProfit || 0), 0);
            const currentMonth = new Date().toISOString().substring(0, 7); // "YYYY-MM"
            const jobsThisMonth = files.filter(file => file.createdAt && file.createdAt.startsWith(currentMonth)).length;
            const avgProfit = files.length > 0 ? totalProfit / files.length : 0;
            
            document.getElementById('stat-total-profit').textContent = totalProfit.toFixed(3);
            document.getElementById('stat-jobs-month').textContent = jobsThisMonth;
            document.getElementById('stat-avg-profit').textContent = avgProfit.toFixed(3);
        }

        // --- CLIENT MANAGEMENT (Firebase) ---
        function openClientManager() { loadClients(); openModal('client-manager-modal'); }
        function loadClients() {
            if (!db) return;
            onSnapshot(collection(db, 'clients'), (snapshot) => {
                clientsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                clientsCache.sort((a, b) => a.name.localeCompare(b.name)); 
                displayClients(clientsCache);
            }, (error) => showNotification("Could not load clients from Firebase.", true));
        }
        function displayClients(clients) {
            const list = document.getElementById('client-list');
            if (clients.length === 0) { list.innerHTML = `<p class="text-gray-500 text-center p-4">No clients found.</p>`; return; }
            list.innerHTML = clients.map(client => `
                <div class="client-item border p-3 rounded-lg bg-gray-50 hover:bg-gray-100" data-search-term="${client.name.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${client.name}</p>
                            <p class="text-sm text-gray-600">${client.address || ''}</p>
                            <p class="text-xs text-gray-500">${client.contactPerson || ''} - ${client.phone || ''}</p>
                        </div>
                        <div class="flex-shrink-0 space-x-2">
                           <button onclick="editClient('${client.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs">Edit</button>
                           <button onclick="confirmDelete('${client.id}', 'client')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        async function saveClient() {
            const id = document.getElementById('client-id').value;
            const data = {
                name: document.getElementById('client-name').value,
                address: document.getElementById('client-address').value,
                contactPerson: document.getElementById('client-contact-person').value,
                phone: document.getElementById('client-phone').value,
                type: document.getElementById('client-type').value,
            };
            if(!data.name) { showNotification("Client name is required.", true); return; }
            showLoader();
            try {
                const docRef = id ? doc(db, 'clients', id) : doc(collection(db, 'clients'));
                await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: true });
                showNotification("Client saved successfully.");
                clearClientForm();
            } catch (e) { console.error(e); showNotification("Error saving client.", true); }
            hideLoader();
        }
        function clearClientForm() {
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('client-form-title').textContent = 'Add New Client';
        }
        function editClient(clientId) {
            const client = clientsCache.find(c => c.id === clientId);
            if(client) {
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-address').value = client.address || '';
                document.getElementById('client-contact-person').value = client.contactPerson || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-type').value = client.type || 'Shipper';
                document.getElementById('client-form-title').textContent = 'Edit Client';
            }
        }
        async function deleteClient(clientId) {
            closeModal('confirm-delete-modal');
            showLoader();
            try { await deleteDoc(doc(db, 'clients', clientId)); showNotification("Client deleted."); }
            catch(e) { showNotification("Error deleting client.", true); }
            hideLoader();
        }
        function setupAutocomplete(inputElement, suggestionsElementId, clientType) {
            const suggestionsPanel = document.getElementById(suggestionsElementId);
            inputElement.addEventListener('input', () => {
                const value = inputElement.value.toLowerCase();
                if (!value) { suggestionsPanel.classList.add('hidden'); return; }

                const filtered = clientsCache.filter(c => 
                    (c.type === clientType || c.type === 'Both') && c.name.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0) {
                    suggestionsPanel.innerHTML = filtered.map(c => `<div class="autocomplete-suggestion" data-name="${c.name}">${c.name}</div>`).join('');
                    suggestionsPanel.classList.remove('hidden');
                } else {
                    suggestionsPanel.classList.add('hidden');
                }
            });
            suggestionsPanel.addEventListener('click', (e) => {
                if (e.target.classList.contains('autocomplete-suggestion')) {
                    inputElement.value = e.target.dataset.name;
                    suggestionsPanel.classList.add('hidden');
                }
            });
            inputElement.addEventListener('blur', () => setTimeout(() => suggestionsPanel.classList.add('hidden'), 150));
        }

        // --- ADMIN PANEL (Firebase) ---
        async function openAdminPanel() {
            if (currentUser.role !== 'admin') { return; }
            showLoader();
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const userListEl = document.getElementById('user-list');
                userListEl.innerHTML = allUsersCache.map(user => {
                    return `
                    <div class="p-2 border-b grid grid-cols-3 gap-4 items-center">
                        <div>
                            <p class="font-medium">${user.displayName}</p>
                            <p class="text-xs text-gray-500">${user.email}</p>
                        </div>
                        <div class="text-sm text-gray-600 capitalize">${user.role}</div>
                        <div>
                            <select data-uid="${user.id}" class="input-field status-select text-sm p-1">
                                <option value="active" ${user.status === 'active' ? 'selected':''}>Active</option>
                                <option value="inactive" ${user.status === 'inactive' ? 'selected':''}>Inactive</option>
                                <option value="blocked" ${user.status === 'blocked' ? 'selected':''}>Blocked</option>
                            </select>
                        </div>
                    </div>`;
                }).join('');
                openModal('admin-panel-modal');
            } catch(e) { showNotification("Could not load user data.", true); }
            hideLoader();
        }
        async function saveUserChanges() {
            showLoader();
            const batch = writeBatch(db);
            document.querySelectorAll('.status-select').forEach(select => {
                const uid = select.dataset.uid;
                const newStatus = select.value;
                const docRef = doc(db, 'users', uid);
                batch.update(docRef, { status: newStatus });
            });
            try {
                await batch.commit();
                showNotification("User changes saved.");
                closeModal('admin-panel-modal');
            } catch(e) { showNotification("Error saving user changes.", true); }
            hideLoader();
        }
        
        // --- Analytics Dashboard ---
        async function openAnalyticsDashboard() {
            if (!analyticsDataCache) {
                const result = await handleApiRequest('list-jobfiles.php?full=true&all=true', { method: 'GET' }, null, "Could not load data for analytics.");
                if (!result || !result.files) return;
                analyticsDataCache = result.files.filter(f => !f.isDeleted); // only non-deleted
            }
            
            const container = document.getElementById('analytics-container');
            container.innerHTML = `
                <div class="container">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2 no-print">
                        <h3 class="text-2xl font-bold">Analytics Dashboard</h3>
                        <div class="flex items-center gap-2">
                             <label for="analytics-date-from" class="text-sm font-medium">From:</label>
                            <input type="date" id="analytics-date-from" class="input-field text-sm p-1">
                             <label for="analytics-date-to" class="text-sm font-medium">To:</label>
                            <input type="date" id="analytics-date-to" class="input-field text-sm p-1">
                            <button id="analytics-apply-filter" class="btn bg-blue-600 text-white py-1 px-3 text-sm">Apply</button>
                        </div>
                        <div>
                            <button onclick="downloadAnalyticsCsv()" title="Download CSV" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded mr-4">📄 CSV</button>
                            <button onclick="printPage()" title="Print Analytics" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">🖨️ Print</button>
                            <button onclick="closeAnalyticsDashboard()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded">Back</button>
                        </div>
                    </div>
                    <div id="analytics-body" class="space-y-6"></div>
                </div>`;
            
            document.getElementById('analytics-apply-filter').addEventListener('click', () => {
                const fromDate = document.getElementById('analytics-date-from').value;
                const toDate = document.getElementById('analytics-date-to').value;
                let filteredFiles = analyticsDataCache;
                if(fromDate) filteredFiles = filteredFiles.filter(f => f.d && f.d >= fromDate);
                if(toDate) filteredFiles = filteredFiles.filter(f => f.d && f.d <= toDate);
                renderAnalytics(filteredFiles);
            });

            renderAnalytics(analyticsDataCache);
            document.getElementById('app-container').style.display = 'none';
            container.style.display = 'block';
        }

        function closeAnalyticsDashboard() {
            document.getElementById('analytics-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }
        function renderAnalytics(files) {
            const body = document.getElementById('analytics-body');
            const totals = files.reduce((acc, file) => {
                acc.cost += file.totalCost || 0;
                acc.selling += file.totalSelling || 0;
                acc.profit += file.totalProfit || 0;
                return acc;
            }, { cost: 0, selling: 0, profit: 0 });

            const monthlyData = files.reduce((acc, file) => {
                if(!file.d) return acc;
                const month = file.d.substring(0, 7); // YYYY-MM
                if(!acc[month]) acc[month] = { cost: 0, selling: 0, profit: 0, count: 0 };
                acc[month].cost += file.totalCost || 0;
                acc[month].selling += file.totalSelling || 0;
                acc[month].profit += file.totalProfit || 0;
                acc[month].count++;
                return acc;
            }, {});
            
            body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Cost</p><p class="text-2xl font-bold">${totals.cost.toFixed(3)}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Selling</p><p class="text-2xl font-bold">${totals.selling.toFixed(3)}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Profit</p><p class="text-2xl font-bold">${totals.profit.toFixed(3)}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow"><canvas id="monthly-profit-chart"></canvas></div>
                    <div class="bg-white p-4 rounded-lg shadow"><canvas id="salesman-profit-chart"></canvas></div>
                </div>
                <div>
                  <h4 class="text-xl font-bold mb-2">Files by Creator</h4>
                  ${renderTableFromData(files, 'createdBy', 'Creator', ['profit', 'count'], 'showUserJobs')}
                </div>
                 <div>
                  <h4 class="text-xl font-bold mb-2">Files by Month (Job Date)</h4>
                  ${renderTableFromData(files, (f) => f.d ? f.d.substring(0, 7) : 'N/A', 'Month', ['profit', 'count'], 'showMonthlyJobs', 'd')}
                </div>
                <div>
                  <h4 class="text-xl font-bold mb-2">Files by Salesman</h4>
                  ${renderTableFromData(files, 'sm', 'Salesman', ['profit', 'count'], 'showSalesmanJobs')}
                </div>
            `;
            // Init Charts
            if (profitChartInstance) profitChartInstance.destroy();
            if (salesmanChartInstance) salesmanChartInstance.destroy();
            const sortedMonths = Object.keys(monthlyData).sort();
            profitChartInstance = new Chart(document.getElementById('monthly-profit-chart'), {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{ label: 'Monthly Profit', data: sortedMonths.map(m => monthlyData[m].profit), tension: 0.1, borderColor: '#16a34a' }]
                },
                options: { plugins: { title: { display: true, text: 'Monthly Profit Over Time' } } }
            });
            const salesmanData = Object.entries(groupData(files, 'sm')).sort((a,b) => b[1].profit - a[1].profit);
             salesmanChartInstance = new Chart(document.getElementById('salesman-profit-chart'), {
                type: 'bar',
                data: {
                    labels: salesmanData.map(s => s[0]),
                    datasets: [{ label: 'Salesman Profit', data: salesmanData.map(s => s[1].profit), backgroundColor: '#2563eb' }]
                },
                options: { plugins: { title: { display: true, text: 'Top Salesmen by Profit' } } }
            });
        }
        
        function groupData(files, keyField) {
             return files.reduce((acc, file) => {
                const key = typeof keyField === 'function' ? keyField(file) : (file[keyField] || 'N/A');
                if(!acc[key]) acc[key] = { profit: 0, cost: 0, selling: 0, count: 0 };
                acc[key].profit += file.totalProfit || 0;
                acc[key].cost += file.totalCost || 0;
                acc[key].selling += file.totalSelling || 0;
                acc[key].count++;
                return acc;
            }, {});
        }

        function renderTableFromData(files, keyField, keyHeader, valueHeaders, clickHandlerName, clickHandlerParamType) {
            const data = groupData(files, keyField);
            let table = `<table class="w-full analytics-table"><thead><tr><th>${keyHeader}</th>`;
            valueHeaders.forEach(h => table += `<th>${h.charAt(0).toUpperCase() + h.slice(1)}</th>`);
            table += '</tr></thead><tbody>';
            Object.entries(data).sort((a, b) => b[1].profit - a[1].profit).forEach(([key, values]) => {
                const param = clickHandlerParamType ? `'${key}','${clickHandlerParamType}'` : `'${key}'`;
                table += `<tr class="hover:bg-gray-100 cursor-pointer" onclick="${clickHandlerName}(${param})"><td>${key}</td>`;
                valueHeaders.forEach(h => table += `<td>${typeof values[h] === 'number' ? (h === 'count' ? values[h] : values[h].toFixed(3)) : values[h]}</td>`);
                table += `</tr>`;
            });
            table += '</tbody></table>';
            return table;
        }

        function showUserJobs(userName) {
            const userFiles = analyticsDataCache.filter(f => (f.createdBy || 'N/A') === userName);
            displayJobFiles(userFiles, 'user-jobs-list');
            document.getElementById('user-jobs-modal-title').textContent = `Job Files Created By ${userName}`;
            openModal('user-jobs-modal', true);
        }
        function showMonthlyJobs(month, dateType) {
            const monthFiles = analyticsDataCache.filter(f => f[dateType] && f[dateType].startsWith(month));
            displayJobFiles(monthFiles, 'user-jobs-list');
            document.getElementById('user-jobs-modal-title').textContent = `Job Files for ${month}`;
            openModal('user-jobs-modal', true);
        }
        function showSalesmanJobs(salesmanName) {
            const salesmanFiles = analyticsDataCache.filter(f => (f.sm || 'N/A') === salesmanName);
            displayJobFiles(salesmanFiles, 'user-jobs-list');
            document.getElementById('user-jobs-modal-title').textContent = `Jobs by Salesman: ${salesmanName}`;
            openModal('user-jobs-modal', true);
        }
        function showStatusJobs(status){
            const statusFiles = jobFilesCache.filter(f => (f.status || 'pending') === status && !f.isDeleted);
            displayJobFiles(statusFiles, 'user-jobs-list');
            document.getElementById('user-jobs-modal-title').textContent = `Job Files with Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
            openModal('user-jobs-modal', true);
        }
        function downloadAnalyticsCsv() {
             let csvContent = "data:text/csv;charset=utf-8,Job File No,Date,Shipper,Consignee,Salesman,Created By,Status,Total Cost,Total Selling,Total Profit\n";
             analyticsDataCache.forEach(file => {
                 const row = [file.jfn, file.d, `"${file.sh}"`, `"${file.co}"`, file.sm, file.createdBy, file.status, file.totalCost, file.totalSelling, file.totalProfit].join(',');
                 csvContent += row + "\r\n";
             });
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `jobfiles_analytics_${new Date().toISOString().split('T')[0]}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }

        // --- Charge & Activity Log (Local Storage) ---
        function openChargeManager() {
            const listEl = document.getElementById('charge-description-list');
            listEl.innerHTML = chargeDescriptions.map(d => `
                <div class="flex justify-between items-center p-2 border-b">
                    <span>${d}</span>
                    <button onclick="deleteChargeDescription('${d}')" class="text-red-500 font-bold">&times;</button>
                </div>
            `).join('');
            openModal('charge-manager-modal');
        }
        function saveChargeDescription() {
            const input = document.getElementById('new-charge-description');
            const newDesc = input.value.trim();
            if(newDesc && !chargeDescriptions.includes(newDesc)){
                chargeDescriptions.unshift(newDesc);
                localStorage.setItem('chargeDescriptions', JSON.stringify(chargeDescriptions));
                input.value = '';
                openChargeManager(); // Refresh list
            }
        }
        function deleteChargeDescription(description) {
            chargeDescriptions = chargeDescriptions.filter(d => d !== description);
            localStorage.setItem('chargeDescriptions', JSON.stringify(chargeDescriptions));
            openChargeManager(); // Refresh list
        }
        function setupChargeAutocomplete(inputElement) {
            const suggestionsPanel = inputElement.nextElementSibling;
            if(!suggestionsPanel) return;
            inputElement.addEventListener('input', () => {
                const value = inputElement.value.toLowerCase();
                suggestionsPanel.innerHTML = '';
                if (!value) { suggestionsPanel.classList.add('hidden'); return; }
                const filtered = chargeDescriptions.filter(d => d.toLowerCase().includes(value));
                if(filtered.length > 0) {
                    suggestionsPanel.innerHTML = filtered.map(d => `<div class="autocomplete-suggestion">${d}</div>`).join('');
                    suggestionsPanel.classList.remove('hidden');
                } else {
                    suggestionsPanel.classList.add('hidden');
                }
            });
            suggestionsPanel.addEventListener('click', e => {
                if (e.target.classList.contains('autocomplete-suggestion')) {
                    inputElement.value = e.target.textContent;
                    suggestionsPanel.classList.add('hidden');
                }
            });
            inputElement.addEventListener('blur', () => setTimeout(() => suggestionsPanel.classList.add('hidden'), 150));
        }
        function logUserActivity(jobFileNo) {
            if (!currentUser || !jobFileNo) return;
            const logEntry = { user: currentUser.displayName, file: jobFileNo, timestamp: new Date().toISOString() };
            let logs = [];
            try { logs = JSON.parse(localStorage.getItem('userActivityLog')) || []; } catch(e) { logs = []; }
            logs.unshift(logEntry);
            if(logs.length > 200) logs.splice(200);
            localStorage.setItem('userActivityLog', JSON.stringify(logs));
        }
        function openUserActivityLog() {
            const logs = JSON.parse(localStorage.getItem('userActivityLog') || '[]');
            const body = document.getElementById('activity-log-body');
            body.innerHTML = logs.map(log => `<tr>
                <td class="table-cell">${log.user}</td>
                <td class="table-cell">${log.file}</td>
                <td class="table-cell">${new Date(log.timestamp).toLocaleString()}</td>
            </tr>`).join('');
            openModal('activity-log-modal');
        }

        // --- RECYCLE BIN & BACKUP ---
        async function openRecycleBin(forceReload = false) {
            showLoader();
            const result = await handleApiRequest('list-jobfiles.php?deleted=true', { method: 'GET' }, null, "Could not load recycle bin.");
            hideLoader();
            if(result && result.files) {
                 if(forceReload) {
                    const nonDeletedFiles = jobFilesCache.filter(f => !f.isDeleted);
                    jobFilesCache = [...nonDeletedFiles, ...result.files];
                 }
                displayJobFiles(result.files, 'recycle-bin-list', true);
                openModal('recycle-bin-modal');
            }
        }
        
        async function backupAllData() {
            const result = await handleApiRequest('list-jobfiles.php?full=true&all=true', { method: 'GET' }, null, "Could not load data for backup.");
            if(!result || !result.files) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(result.files, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `jobfiles_backup_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification("Backup downloaded.");
        }

        async function restoreFromBackup() {
            const confirmed = confirm("This is a developer tool. Are you sure you want to restore all job files from the backup file? This will overwrite any existing files with the same name.");
            if (!confirmed) return;
            const result = await handleApiRequest('restore.php', { method: 'GET' }, null, "Failed to restore data.");
            if(result) {
                showNotification(result.message);
                loadAllJobFilesForCache();
            }
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); 
            
            // Global Function Assignment
            window.closeModal = closeModal; window.printPage = printPage;
            window.openFileManager = openFileManager; window.saveJobFile = saveJobFile; window.clearForm = clearForm;
            window.printPreview = printPreview; window.openClientManager = openClientManager; window.openRecycleBin = openRecycleBin;
            window.loadJobFileById = loadJobFileById; window.previewJobFileById = previewJobFileById;
            window.confirmDelete = confirmDelete; window.restoreJobFile = restoreJobFile;
            window.checkJobFile = checkJobFile; window.approveJobFile = approveJobFile; window.promptForRejection = promptForRejection;
            window.addChargeRow = addChargeRow; window.openChargeManager = openChargeManager;
            window.saveChargeDescription = saveChargeDescription; window.deleteChargeDescription = deleteChargeDescription;
            window.openAdminPanel = openAdminPanel; window.saveUserChanges = saveUserChanges;
            window.editClient = editClient; window.showUserJobs = showUserJobs; window.showMonthlyJobs = showMonthlyJobs;
            window.showSalesmanJobs = showSalesmanJobs;
            window.showStatusJobs = showStatusJobs;
            window.openAnalyticsDashboard = openAnalyticsDashboard; window.closeAnalyticsDashboard = closeAnalyticsDashboard;
            window.downloadAnalyticsCsv = downloadAnalyticsCsv;
            window.openUserActivityLog = openUserActivityLog; window.backupAllData = backupAllData;
            window.restoreFromBackup = restoreFromBackup;
            window.rejectJobFile = rejectJobFile;
            
            // Load local data
            chargeDescriptions = JSON.parse(localStorage.getItem('chargeDescriptions') || '["Ex-works Charges:", "Land/Air / Sea Freight:", "Fuell Security / War Surcharge:", "Formalities:", "Delivery Order Fee:", "Transportation Charges:", "Inspection / Computer Print Charges:", "Handling Charges:", "Labor / Forklift Charges:", "Documentation Charges:", "Clearance Charges:", "Customs Duty:", "Terminal Handling Charges:", "Legalization Charges:", "Demurrage Charges:", "Loading / Offloading Charges:", "Destination Clearance Charges:", "Packing Charges:", "Port Charges:", "Other Charges:", "PAI Approval :", "Insurance Fee :", "EPA Charges :"]');

            // Event Listeners
            let isLoginView = true;
            document.getElementById('auth-link').addEventListener('click', (e) => { e.preventDefault(); isLoginView = !isLoginView; toggleAuthView(isLoginView); });
            document.getElementById('auth-btn').addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                if (isLoginView) { handleLogin(email, password); } 
                else { const name = document.getElementById('full-name').value; handleSignUp(email, password, name); }
            });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); openModal('forgot-password-modal'); });
            document.getElementById('send-reset-link-btn').addEventListener('click', handleForgotPassword);
            
            document.getElementById('activity-log-btn').addEventListener('click', openUserActivityLog);
            document.getElementById('admin-panel-btn').addEventListener('click', openAdminPanel);
            
            document.getElementById('check-btn').addEventListener('click', () => checkJobFile(null));
            document.getElementById('approve-btn').addEventListener('click', () => approveJobFile(null));
            document.getElementById('reject-btn').addEventListener('click', () => promptForRejection(null));
            document.getElementById('confirm-reject-btn').addEventListener('click', rejectJobFile);
            
            // Filter Listeners
            const applyFilters = () => applyFiltersAndDisplay();
            document.getElementById('search-bar').addEventListener('input', applyFilters);
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-date-from').addEventListener('change', applyFilters);
            document.getElementById('filter-date-to').addEventListener('change', applyFilters);
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('search-bar').value = ''; document.getElementById('filter-status').value = '';
                document.getElementById('filter-date-from').value = ''; document.getElementById('filter-date-to').value = '';
                applyFilters();
            });
            
            // Client Manager Listeners
            document.getElementById('client-form').addEventListener('submit', (e) => { e.preventDefault(); saveClient(); });
            document.getElementById('clear-client-form-btn').addEventListener('click', clearClientForm);
            document.getElementById('client-search-bar').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = clientsCache.filter(c => c.name.toLowerCase().includes(term));
                displayClients(filtered);
            });
            setupAutocomplete(document.getElementById('shipper-name'), 'shipper-suggestions', 'Shipper');
            setupAutocomplete(document.getElementById('consignee-name'), 'consignee-suggestions', 'Consignee');
            
             document.getElementById('confirm-delete-modal').querySelector('button[onclick^="closeModal"]').addEventListener('click', () => {
                closeModal('confirm-delete-modal');
                // The dynamic listener removal is handled by the confirmDelete function itself
            });

        });
    </script>
</body>
</html>
