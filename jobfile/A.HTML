
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q'go Cargo - Job File System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #0E639C; --accent-color: #4FB8AF; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 1rem auto; padding: 1.5rem; }
        @media (min-width: 640px) { .container { margin: 2rem auto; padding: 2.5rem; } }
        .input-field, select {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: white;
        }
        .input-field:focus, select:focus { outline: none; border-color: var(--theme-color); box-shadow: 0 0 0 2px rgba(14, 99, 156, 0.2); }
        .input-field:disabled, .input-field[readonly] { background-color: #f3f4f6; cursor: not-allowed; color: #6b7280; }
        .table-cell { border: 1px solid #e5e7eb; padding: 0.5rem; position: relative; }
        @media (min-width: 640px) { .table-cell { padding: 0.75rem; } }
        .table-cell input { width: 100%; border: none; padding: 0; background-color: transparent; }
        .table-cell input:focus { outline: none; }
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 1rem;
        }
        .overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem; width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content { transform: scale(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%; background-color: #2d3748; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translate(-50%, 100px); opacity: 0; transition: transform 0.5s, opacity 0.5s; z-index: 2000; text-align: center;
        }
        #notification.show { transform: translate(-50%, 0); opacity: 1; }
        .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only { display: none; }
        .stamp { position: absolute; top: -10px; right: -10px; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; text-transform: uppercase; transform: rotate(15deg); opacity: 0.8; display: none; }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }
        .autocomplete-suggestions {
            border: 1px solid #d1d5db; border-top: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 150px; overflow-y: auto;
            position: absolute; background-color: white; z-index: 999; width: 100%;
        }
        .autocomplete-suggestion { padding: 0.5rem; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <!-- Content will be injected by JS -->
    </div>

    <!-- Main App -->
    <div id="app-container" class="container hidden">
        <!-- Content will be injected by JS -->
    </div>
    
    <!-- Modals, loader, etc. -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    <div id="file-manager-modal" class="overlay"></div>
    <div id="print-preview-modal" class="overlay"></div>
    <div id="analytics-modal" class="overlay"></div>
    <div id="client-manager-modal" class="overlay"></div>
    <div id="admin-panel-modal" class="overlay"></div>
    <div id="recycle-bin-modal" class="overlay"></div>
    <div id="charge-manager-modal" class="overlay"></div>
    <div id="activity-log-modal" class="overlay"></div>
    <div id="confirm-reject-modal" class="overlay"></div>
    <div id="confirm-delete-modal" class="overlay"></div>
    <div id="confirm-restore-modal" class="overlay"></div>
    <div id="forgot-password-modal" class="overlay"></div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- NO MODULES, ALL IN GLOBAL SCOPE ---
        // This script is intentionally a single, large block to avoid scope issues.
        
        document.addEventListener('DOMContentLoaded', () => {

            // --- GLOBAL STATE ---
            let db, auth;
            let currentUser = null;
            let jobFilesCache = [];
            let clientsCache = [];
            let allUsersCache = [];
            let chargeDescriptions = [];
            let currentJobFile = null;
            let profitChartInstance, salesmanChartInstance;
            let fileIdToReject = null;
            let isLoginView = true;

            // --- DOM TEMPLATES ---
            const loginTemplate = `
                <div class="max-w-md w-full space-y-8">
                    <div><img class="mx-auto h-20 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo"></div>
                    <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
                    <div id="approval-message" class="hidden text-center p-4 bg-yellow-100 text-yellow-800 rounded-md">Thank you for signing up. Your account is awaiting admin approval.</div>
                    <div id="blocked-message" class="hidden text-center p-4 bg-red-100 text-red-800 rounded-md">Your account has been blocked. Please contact an administrator.</div>
                    <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                        <div class="rounded-md shadow-sm -space-y-px">
                            <div id="signup-name-field" style="display: none;"><input id="full-name" name="name" type="text" class="input-field rounded-t-md" placeholder="Full Name"></div>
                            <div><input id="email-address" name="email" type="email" required class="input-field rounded-b-md" placeholder="Email address"></div>
                            <div><input id="password" name="password" type="password" required class="input-field rounded-t-md mt-2" placeholder="Password"></div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
                            <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">Create a new account</a>
                        </div>
                        <div><button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Sign in</button></div>
                    </div>
                </div>`;
            
            const appTemplate = `
                <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b-2 border-gray-200">
                    <div><img class="h-16 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo"></div>
                    <div class="text-right mt-4 sm:mt-0">
                        <p>Welcome, <strong id="user-display-name"></strong> (<span id="user-role" class="capitalize"></span>)</p>
                        <button id="logout-btn" class="text-sm text-indigo-600 hover:text-indigo-800">Logout</button>
                    </div>
                </header>

                <div id="main-page-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <!-- Form content will be injected here -->
                    <form id="job-file-form"></form>
                </div>
            `;

            // Injecting templates
            document.getElementById('login-screen').innerHTML = loginTemplate;
            document.getElementById('app-container').innerHTML = appTemplate;


            // --- CORE UTILITY FUNCTIONS ---
            const getEl = (id) => document.getElementById(id);
            const querySel = (selector) => document.querySelector(selector);
            const querySelAll = (selector) => document.querySelectorAll(selector);
            const showLoader = () => getEl('loader-overlay').classList.add('visible');
            const hideLoader = () => getEl('loader-overlay').classList.remove('visible');
            
            const showNotification = (message, isError = false) => {
                const notification = getEl('notification');
                if (!notification) return;
                notification.textContent = message;
                notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            };

            const openModal = (id) => { getEl(id).classList.add('visible'); };
            const closeModal = (id) => { getEl(id).classList.remove('visible'); };
            const closeAllModals = () => querySelAll('.overlay').forEach(modal => modal.classList.remove('visible'));

            
            // --- MAIN APP LOGIC ---

            const handleApiRequest = async (script, options, successMessage, errorMessage) => {
                showLoader();
                try {
                    const response = await fetch(script, options);
                    if (!response.ok) throw new Error(`Server responded with ${response.status}: ${await response.text() || 'Server Error'}`);
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message || 'An unknown error occurred.');
                    if (successMessage) showNotification(successMessage);
                    return result;
                } catch (error) {
                    console.error(`Error in ${script}:`, error);
                    showNotification(`${errorMessage} (${error.message})`, true);
                    return null;
                } finally {
                    hideLoader();
                }
            };
            
            // --- Authentication ---
            const handleSignUp = async (email, password, displayName) => {
                showLoader();
                try {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                    showNotification("Account created! Please wait for admin approval.", false);
                    await firebase.auth().signOut();
                    toggleAuthView(true);
                } catch (error) { showNotification(error.message, true); }
                hideLoader();
            };

            const handleLogin = async (email, password) => {
                showLoader();
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) { showNotification("Incorrect email or password.", true); }
                hideLoader();
            };
            
            const handleForgotPassword = async () => {
                const email = getEl('reset-email').value.trim();
                if (!email) { showNotification("Please enter your email address.", true); return; }
                showLoader();
                try {
                    await firebase.auth().sendPasswordResetEmail(email);
                    hideLoader();
                    closeModal('forgot-password-modal');
                    showNotification("Password reset link sent!", false);
                } catch (error) { hideLoader(); showNotification("Could not send reset link.", true); }
            };
            
            const handleLogout = () => firebase.auth().signOut();

            const toggleAuthView = (isLogin) => {
                isLoginView = isLogin;
                getEl('auth-title').textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
                getEl('auth-btn').textContent = isLogin ? 'Sign in' : 'Sign up';
                getEl('auth-link').textContent = isLogin ? 'Create a new account' : 'Already have an account? Sign in';
                getEl('signup-name-field').style.display = isLogin ? 'none' : 'block';
                const emailField = getEl('email-address');
                emailField.classList.toggle('rounded-t-md', !isLogin);
                emailField.classList.toggle('rounded-md', isLogin);
            };
            
            const showLoginScreen = () => {
                getEl('login-screen').style.display = 'flex';
                getEl('app-container').style.display = 'none';
            };

            const showApp = async () => {
                getEl('login-screen').style.display = 'none';
                getEl('app-container').style.display = 'block';

                if (currentUser) {
                    getEl('user-display-name').textContent = currentUser.displayName;
                    getEl('user-role').textContent = currentUser.role;
                }
                
                await loadAllJobFilesForCache();
                
                // Now call clearForm after data is likely loaded and UI is stable
                clearForm();
            };
            
            // --- JOB FILE FUNCTIONS ---
            const loadAllJobFilesForCache = async () => {
                const result = await handleApiRequest('jobfile/list-jobfiles.php?full=true&all=true', { method: 'GET' }, null, "Failed to load initial data.");
                if (result && result.files) {
                    jobFilesCache = result.files.filter(f => !f.isDeleted);
                    updateMainPageStats();
                    return true;
                }
                jobFilesCache = [];
                updateMainPageStats();
                return false;
            };

            const openFileManager = async () => {
                showLoader();
                const result = await handleApiRequest('jobfile/list-jobfiles.php', { method: 'GET' }, null, "Failed to load file list.");
                hideLoader();
                if(result && result.files) {
                    jobFilesCache = result.files;
                    // Inject file manager modal HTML and then display
                    const fmModal = getEl('file-manager-modal');
                    fmModal.innerHTML = `<div class="modal-content max-w-4xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold">File Manager</h3>
                            <button id="close-fm-btn" class="text-gray-500 text-3xl">&times;</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="fm-search-bar" class="input-field col-span-2" placeholder="Search by Job No, Shipper, Consignee...">
                            <select id="fm-filter-status" class="input-field"><option value="">All Statuses</option><option value="pending">Pending</option><option value="checked">Checked</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select>
                            <button id="fm-clear-filters-btn" class="py-2 px-4 bg-gray-200 rounded-md">Clear</button>
                        </div>
                         <div id="fm-status-summary" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-center"></div>
                        <div id="job-files-list" class="space-y-2 max-h-[50vh] overflow-y-auto p-2 bg-gray-50 rounded"></div>
                    </div>`;
                    
                    getEl('close-fm-btn').addEventListener('click', () => closeModal('file-manager-modal'));
                    getEl('fm-search-bar').addEventListener('input', applyFiltersAndDisplay);
                    getEl('fm-filter-status').addEventListener('change', applyFiltersAndDisplay);
                    getEl('fm-clear-filters-btn').addEventListener('click', () => {
                        getEl('fm-search-bar').value = '';
                        getEl('fm-filter-status').value = '';
                        applyFiltersAndDisplay();
                    });

                    applyFiltersAndDisplay();
                    openModal('file-manager-modal');
                }
            };
            
            const applyFiltersAndDisplay = () => {
                const searchTerm = getEl('fm-search-bar').value.toLowerCase();
                const statusFilter = getEl('fm-filter-status').value;

                let filteredFiles = jobFilesCache.filter(file => {
                    const searchData = [file.jfn, file.sh, file.co].join(' ').toLowerCase();
                    if (searchTerm && !searchData.includes(searchTerm)) return false;
                    if (statusFilter && file.status !== statusFilter) return false;
                    return true;
                });
                
                // Sort by date, ensuring dates are valid before comparing
                filteredFiles.sort((a,b) => {
                    const dateA = new Date(a.updatedAt || 0).getTime();
                    const dateB = new Date(b.updatedAt || 0).getTime();
                    return dateB - dateA;
                });
                
                displayJobFiles(filteredFiles);
                updateStatusSummary('fm-status-summary', filteredFiles);
            };

            const displayJobFiles = (files) => {
                const list = getEl('job-files-list');
                if (!list) return;
                if (files.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center p-4">No job files match the current filters.</p>`;
                    return;
                }
                const filesHtml = files.map(docData => {
                    const deleteButton = currentUser.role === 'admin' ? `<button class="file-action-btn bg-red-500" data-action="delete" data-id="${docData.id}">Delete</button>` : '';
                    const lastUpdated = new Date(docData.updatedAt).toLocaleString();
                    return `
                        <div class="job-file-item border p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-white hover:bg-gray-50 gap-2">
                            <div class="text-center sm:text-left">
                                <p class="font-bold text-indigo-700">${docData.jfn || 'No ID'}</p>
                                <p class="text-sm text-gray-600">Shipper: ${docData.sh || 'N/A'} | Consignee: ${docData.co || 'N/A'}</p>
                                <p class="text-xs text-gray-400">Last Updated: ${lastUpdated}</p>
                            </div>
                            <div class="space-x-2 flex-shrink-0">
                                <button class="file-action-btn bg-blue-500" data-action="preview" data-id="${docData.id}">Preview</button>
                                <button class="file-action-btn bg-green-500" data-action="load" data-id="${docData.id}">Load</button>
                                ${deleteButton}
                            </div>
                        </div>`;
                }).join('');
                list.innerHTML = filesHtml;

                // Add event listeners to the new buttons
                querySelAll('.file-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { action, id } = e.target.dataset;
                        if (action === 'load') loadJobFileById(id);
                        if (action === 'preview') previewJobFileById(id);
                        if (action === 'delete') confirmDelete(id);
                    });
                });
            };

            const clearForm = () => {
                // This will be implemented fully once form is generated
                if(getEl('job-file-form')) getEl('job-file-form').innerHTML = "Form cleared or ready for new entry.";
                currentJobFile = null;
            }
            
            // --- ANALYTICS FUNCTIONS ---
            const openAnalyticsDashboard = async () => {
                showLoader();
                const result = await handleApiRequest('jobfile/list-jobfiles.php?full=true&all=true', { method: 'GET' }, null, "Failed to load analytics data.");
                hideLoader();
                if(result && result.files) {
                     // Inject analytics modal HTML
                     getEl('analytics-modal').innerHTML = `<div class="modal-content max-w-6xl">
                        <!-- ... Modal header and filter content ... -->
                        <div id="analytics-content-body"></div>
                     </div>`;
                     // This is where you would call a function to render charts and tables
                     // renderAnalytics(result.files);
                     showNotification("Analytics loaded, rendering is pending implementation.", false);
                     openModal('analytics-modal');
                }
            }

            // --- More placeholder functions to be defined ---
            const updateMainPageStats = () => { /* ... */ };
            const updateStatusSummary = () => { /* ... */ };
            const loadJobFileById = (id) => { showNotification(`Load action for ${id} triggered.`, false); };
            const previewJobFileById = (id) => { showNotification(`Preview action for ${id} triggered.`, false); };
            const confirmDelete = (id) => { showNotification(`Delete action for ${id} triggered.`, false); };
            

            // --- INITIALIZER ---
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
                    authDomain: "my-job-file-system.firebaseapp.com",
                    projectId: "my-job-file-system",
                };
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const userDocRef = db.collection('users').doc(user.uid);
                        let userDoc = await userDocRef.get();
                        if (!userDoc.exists()) {
                            // Logic for first-time user
                            const usersCollectionRef = db.collection('users');
                            const userQuerySnapshot = await usersCollectionRef.get();
                            const isFirstUser = userQuerySnapshot.size === 0;
                            const newUser = {
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                role: isFirstUser ? 'admin' : 'user',
                                status: isFirstUser ? 'active' : 'inactive',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await userDocRef.set(newUser);
                            userDoc = await userDocRef.get();
                        }
                        
                        const userData = userDoc.data();
                        if (userData.status === 'inactive') {
                            showLoginScreen();
                            getEl('approval-message').style.display = 'block';
                            firebase.auth().signOut();
                            return;
                        }
                         if (userData.status === 'blocked') {
                            showLoginScreen();
                            getEl('blocked-message').style.display = 'block';
                            firebase.auth().signOut();
                            return;
                        }
                        
                        currentUser = { uid: user.uid, ...userData };
                        console.log("User logged in:", currentUser);
                        await showApp();
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLoginScreen();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
            }

            // --- EVENT LISTENERS BINDING ---
            getEl('auth-link').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthView(!isLoginView);
            });

            getEl('auth-btn').addEventListener('click', () => {
                const email = getEl('email-address').value;
                const password = getEl('password').value;
                if (isLoginView) {
                    handleLogin(email, password);
                } else {
                    const name = getEl('full-name').value;
                    handleSignUp(email, password, name);
                }
            });
            
            // This is a placeholder. The real buttons will be inside the app container.
            // We need to use event delegation or re-bind after app container is populated.
            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'logout-btn') handleLogout();
                // We'll add more buttons here once the form is generated.
                // For now, let's just make sure the top-level buttons work.
                
                // This is a crude way to handle dynamically added buttons for now
                if(e.target.id === 'analytics-btn') openAnalyticsDashboard();
                if(e.target.id === 'file-manager-btn') openFileManager();
                if(e.target.id === 'clear-form-btn') clearForm();
                
            });

        }); // END of DOMContentLoaded
    </script>
</body>
</html>
