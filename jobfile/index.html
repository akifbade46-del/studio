<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Job File System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="text-center text-5xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                 <div id="blocked-message" class="hidden p-4 text-center text-red-800 bg-red-100 rounded-lg">
                    Your account has been blocked by an administrator.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field" style="display: none;">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
                <div class="text-center mt-2 text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Reset Password</h3>
                <button id="close-forgot-password-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <p class="mb-4 text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
            <div>
                <label for="reset-email" class="sr-only">Email address</label>
                <input id="reset-email" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
            </div>
            <div class="text-right mt-6">
                <button id="send-reset-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                    Send Password Reset Link
                </button>
            </div>
        </div>
    </div>

    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- UI Helper Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }
        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function toggleAuthView(isLoginView) {
            const nameField = document.getElementById('signup-name-field');
            const emailField = document.getElementById('email-address');
            const passwordField = document.getElementById('password');
            
            document.getElementById('auth-title').textContent = isLoginView ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = isLoginView ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = isLoginView ? 'Create a new account' : 'Already have an account? Sign in';
            nameField.style.display = isLoginView ? 'none' : 'block';
            
            if (isLoginView) {
                emailField.classList.remove('rounded-t-md');
                passwordField.classList.remove('rounded-b-md');
            } else {
                emailField.classList.add('rounded-t-md');
                passwordField.classList.add('rounded-b-md');
            }

            document.getElementById('approval-message').style.display = 'none';
            document.getElementById('blocked-message').style.display = 'none';
        }

        // --- Authentication Logic ---
        async function handleSignUp(email, password, displayName) {
            showLoader();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const usersCollectionRef = collection(db, 'users');
                const userQuerySnapshot = await getDocs(usersCollectionRef);
                const isFirstUser = userQuerySnapshot.size === 0;

                const newUser = {
                    email: user.email,
                    displayName: displayName,
                    role: isFirstUser ? 'admin' : 'user',
                    status: isFirstUser ? 'active' : 'inactive',
                    createdAt: serverTimestamp()
                };
                await setDoc(doc(db, 'users', user.uid), newUser);
                
                hideLoader();
                if (isFirstUser) {
                     showNotification("Admin account created successfully! You will be logged in.", false);
                } else {
                    showNotification("Account created! Please wait for admin approval.", false);
                    await signOut(auth); 
                    toggleAuthView(true);
                }
            } catch (error) {
                hideLoader();
                console.error("Sign up error:", error);
                showNotification(error.message, true);
            }
        }

        async function handleLogin(email, password) {
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the redirect
            } catch (error) {
                hideLoader();
                console.error("Login error:", error);
                let message = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Incorrect email or password. Please try again or reset your password.";
                }
                showNotification(message, true);
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email) {
                showNotification("Please enter your email address.", true);
                return;
            }
            showLoader();
            try {
                await sendPasswordResetEmail(auth, email);
                hideLoader();
                closeModal('forgot-password-modal');
                showNotification("Password reset link sent! Check your email inbox.", false);
            } catch (error) {
                hideLoader();
                console.error("Password reset error:", error);
                let message = "Could not send reset link. Please try again.";
                if(error.code === 'auth/user-not-found'){
                    message = "No account found with this email address.";
                }
                showNotification(message, true);
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('auth-link').addEventListener('click', (e) => {
                e.preventDefault();
                const isCreatingAccount = e.target.textContent.includes('Create a new account');
                toggleAuthView(!isCreatingAccount);
            });

            document.getElementById('auth-btn').addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                const isLogin = document.getElementById('auth-btn').textContent.includes('Sign in');

                if (isLogin) {
                    handleLogin(email, password);
                } else {
                    const displayName = document.getElementById('full-name').value;
                     if (!email || !password || !displayName) {
                         showNotification("Please fill all fields to sign up.", true);
                         return;
                    }
                    handleSignUp(email, password, displayName);
                }
            });
            
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); openModal('forgot-password-modal'); });
            document.getElementById('send-reset-link-btn').addEventListener('click', handleForgotPassword);
            document.getElementById('close-forgot-password-btn').addEventListener('click', () => closeModal('forgot-password-modal'));
        }

        // --- App Initialization ---
        function initializeAppLogic() {
            // Set up button clicks immediately
            setupEventListeners();

            // Then, check auth state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // A user is signed in. Check their status in Firestore.
                    showLoader();
                    const userDocRef = doc(db, 'users', user.uid);
                    try {
                        const userDoc = await getDoc(userDocRef);
                        
                        if (userDoc.exists()) {
                            const currentUserData = userDoc.data();
                            if (currentUserData.status === 'active') {
                                // User is active and approved, redirect to the main app
                                window.location.href = 'app.html';
                            } else {
                                // User is inactive or blocked, show message and log them out
                                if (currentUserData.status === 'inactive') {
                                    document.getElementById('approval-message').style.display = 'block';
                                    document.getElementById('blocked-message').style.display = 'none';
                                } else if (currentUserData.status === 'blocked') {
                                    document.getElementById('approval-message').style.display = 'none';
                                    document.getElementById('blocked-message').style.display = 'block';
                                }
                                await signOut(auth); // Sign out to prevent redirect loop
                                hideLoader();
                            }
                        } else {
                           // This case is for when a user exists in Auth but not Firestore. 
                           // This can happen on first sign-up with social providers, etc.
                           // For this app, we just log them out.
                           await signOut(auth);
                           hideLoader();
                        }
                    } catch (error) {
                        console.error("Error fetching user data:", error);
                        showNotification("Could not verify user status. Please try again.", true);
                        await signOut(auth);
                        hideLoader();
                    }

                } else {
                    // User is logged out, ensure login screen is visible and loader is hidden.
                    hideLoader();
                }
            });
        }

        // Start the application logic
        initializeAppLogic();
    </script>
</body>
</html>
