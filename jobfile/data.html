<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Q'go Cargo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="text-center text-5xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field" style="display: none;">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
                <div class="text-center mt-2 text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900">Reset Password</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Enter your email address and we will send you a link to reset your password.</p>
                    <input id="reset-email" type="email" class="mt-3 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Email address">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="send-reset-link-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Send Reset Link
                    </button>
                    <button id="cancel-reset-btn" class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLogin = true;

        // Check if user is already logged in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().status === 'active') {
                    window.location.href = 'index.html';
                }
            }
        });

        // Toggle between login and signup
        document.getElementById('auth-link').addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            toggleAuthView(isLogin);
        });

        // Handle auth button click
        document.getElementById('auth-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            
            if (isLogin) {
                await handleLogin(email, password);
            } else {
                const displayName = document.getElementById('full-name').value;
                if (!email || !password || !displayName) {
                    showNotification("Please fill all fields to sign up.", true);
                    return;
                }
                await handleSignUp(email, password, displayName);
            }
        });

        // Forgot password
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('forgot-password-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-reset-btn').addEventListener('click', () => {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        });

        document.getElementById('send-reset-link-btn').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value.trim();
            if (!email) {
                alert("Please enter your email address.");
                return;
            }
            
            try {
                await sendPasswordResetEmail(auth, email);
                document.getElementById('forgot-password-modal').classList.add('hidden');
                alert("Password reset link sent! Check your email inbox.");
            } catch (error) {
                console.error("Password reset error:", error);
                alert("Could not send reset link. Please try again.");
            }
        });

        function toggleAuthView(showLogin) {
            const nameField = document.getElementById('signup-name-field');
            const emailField = document.getElementById('email-address');
            
            document.getElementById('auth-title').textContent = showLogin ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = showLogin ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = showLogin ? 'Create a new account' : 'Already have an account? Sign in';
            nameField.style.display = showLogin ? 'none' : 'block';
            emailField.classList.toggle('rounded-t-md', showLogin);
            document.getElementById('approval-message').style.display = 'none';
        }

        async function handleLogin(email, password) {
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                let message = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Incorrect email or password. Please try again or reset your password.";
                }
                alert(message);
            }
        }

        async function handleSignUp(email, password, displayName) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Check if this is the first user (admin)
                const usersCollectionRef = collection(db, 'users');
                const userQuerySnapshot = await getDocs(usersCollectionRef);
                const isFirstUser = userQuerySnapshot.size === 0;

                const newUser = {
                    email: email,
                    displayName: displayName,
                    role: isFirstUser ? 'admin' : 'user',
                    status: isFirstUser ? 'active' : 'inactive',
                    createdAt: serverTimestamp()
                };

                await setDoc(doc(db, 'users', userCredential.user.uid), newUser);
                
                if (isFirstUser) {
                    alert("Admin account created successfully!");
                    window.location.href = 'index.html';
                } else {
                    alert("Account created! Please wait for admin approval.");
                    await signOut(auth);
                    toggleAuthView(true);
                }
            } catch (error) {
                console.error("Sign up error:", error);
                alert(error.message);
            }
        }

        function showNotification(message, isError = false) {
            alert(message);
        }
    </script>
</body>
</html>